<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Roguechain — d100 Long Threads (Mobile)</title>
<style>
  :root{
    --bg:#0b0f14;--panel:#0f1620;--panel2:#0d141d;--ink:#e6edf3;--muted:#9aa5b1;--accent:#72a1ff;--good:#42d392;--bad:#ff6b6b;--edge:#1f2a37;
    --shadow: 0 8px 30px rgba(0,0,0,.45)
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink);-webkit-tap-highlight-color:transparent}
  .wrap{max-width:960px;margin:0 auto;padding:16px}
  header{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin-bottom:12px}
  .brand{font-weight:800;letter-spacing:.3px;font-size:clamp(16px,2.5vw,20px)}
  .wallet{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .pill{background:var(--panel);border:1px solid var(--edge);padding:8px 10px;border-radius:10px;display:flex;gap:8px;align-items:center;font-size:14px}
  button{background:var(--panel2);border:1px solid var(--edge);border-radius:12px;padding:10px 14px;color:var(--ink);cursor:pointer;font-weight:600}
  button:active{transform:scale(0.98)}
  button:hover{border-color:#315a9f}
  button.primary{background:#1b2736;border-color:#315a9f}
  main{display:grid;grid-template-columns:1.2fr .8fr;gap:12px}
  @media (max-width:860px){main{grid-template-columns:1fr}}
  .card{background:var(--panel);border:1px solid var(--edge);border-radius:14px;padding:12px;box-shadow:var(--shadow)}
  h2{margin:0 0 8px;font-size:18px}
  .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin:8px 0}
  @media (max-width:520px){.stats{grid-template-columns:repeat(2,1fr)}}
  .stat{background:var(--panel2);border:1px solid var(--edge);border-radius:12px;padding:8px;text-align:center;font-size:14px}
  .choices{display:flex;flex-direction:column;gap:8px;margin-top:8px}
  .choices button{width:100%;text-align:left;display:flex;justify-content:space-between;align-items:center;gap:10px}
  .choices .req{opacity:.8;font-size:12px}
  .log{max-height:300px;overflow:auto;background:var(--panel2);border:1px solid var(--edge);border-radius:12px;padding:10px;font:13px/1.5 ui-monospace,Consolas,Menlo,monospace}
  .log .good{color:var(--good)} .log .bad{color:var(--bad)}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .hint{color:var(--muted);font-size:12px}
  .divider{height:1px;background:var(--edge);margin:8px 0}
  .tombstones{font:13px/1.4 ui-monospace,Consolas,Menlo,monospace}
  .muted{color:var(--muted)}

  /* Scenario box */
  .scenario{background:var(--panel2);border:1px solid var(--edge);border-radius:12px;padding:10px}
  .scenario h3{margin:0 0 6px;font-size:16px}
  .scenario p{margin:0;color:#c8d0d8}
  .tag{display:inline-block;background:#1a2432;border:1px solid #2a3a52;border-radius:999px;padding:3px 8px;margin-right:6px;font-size:11px;color:#9fb4d6}

  /* d100 die + modal */
  .die{width:100px;height:100px;border-radius:14px;background:radial-gradient(60% 60% at 50% 45%,#1a2432 0%,#0f1620 100%);border:2px solid var(--edge);
       display:flex;align-items:center;justify-content:center;font:800 26px/1 ui-monospace,Consolas;color:#b8d3ff;position:relative;user-select:none}
  .die .label{position:absolute;bottom:4px;left:6px;font:10px/1.2 ui-monospace;color:var(--muted)}
  .die.rolling{animation:shake .9s ease-in-out}
  @keyframes shake{0%{transform:rotate(0)}25%{transform:rotate(6deg)}50%{transform:rotate(-6deg)}75%{transform:rotate(3deg)}100%{transform:rotate(0)}}

  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:16px}
  .modal.show{display:flex}
  .modal .sheet{max-width:520px;width:100%;background:var(--panel);border:1px solid var(--edge);border-radius:14px;padding:16px;box-shadow:var(--shadow)}
  .modal h3{margin:0 0 6px;font-size:18px}
  .modal .sub{color:var(--muted);font-size:13px;margin-bottom:8px}
  .modal .result{margin-top:10px;font-weight:700}
  .result.success{color:var(--good)} .result.fail{color:var(--bad)}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">Roguechain — d100 Long Threads</div>
      <div class="wallet">
        <div class="pill" id="balance">Balance: 0.00 FAKE</div>
        <button id="btnFaucet">Add Test Coins</button>
        <button id="btnWithdraw">Withdraw 5.00</button>
      </div>
    </header>

    <main>
      <section class="card">
        <h2>Adventure</h2>
        <div class="row">
          <button id="btnStart" class="primary">Start Run (Pay Entry Fee)</button>
          <div class="pill" id="entryFee">Entry fee: 5.00 FAKE</div>
          <div class="pill" id="pass">No Character Pass</div>
        </div>

        <div class="stats">
          <div class="stat">HP <div id="sHP">—</div></div>
          <div class="stat">Resolve <div id="sRV">—</div></div>
          <div class="stat">Light <div id="sL">—</div></div>
          <div class="stat">Rations <div id="sR">—</div></div>
          <div class="stat">Gold <div id="sG">—</div></div>
          <div class="stat">Depth <div id="sD">—</div></div>
        </div>

        <div class="row" id="invRow" style="display:none">
          <div class="pill" id="invText">Items: —</div>
          <button id="btnUseBandage" style="display:none">Use bandage (+2 HP)</button>
          <button id="btnUseTorch" style="display:none">Use torch (+1 Light)</button>
        </div>

        <div id="campRow" class="row" style="display:none">
          <button id="btnRetire">Retire at Camp (Cash Out)</button>
          <span class="hint">Camps appear every 4 depths. Retire here to bank your haul.</span>
        </div>

        <div class="scenario" id="scenarioBox" style="display:none">
          <div class="row" style="justify-content:space-between;align-items:center">
            <h3 id="scTitle" style="margin:0">—</h3>
            <div id="scTags"></div>
          </div>
          <p id="scText">—</p>
        </div>

        <div class="divider"></div>
        <div class="choices" id="choices"></div>

        <div class="divider"></div>
        <div class="log" id="log"></div>
      </section>

      <aside class="card">
        <h2>How it works</h2>
        <ul class="muted">
          <li>Each run follows a **coherent thread** (3 arcs), each with **20 stages**.</li>
          <li>Every turn presents a fresh scenario with **4 options** and varied DCs.</li>
          <li>After choosing, a **dice window** opens to roll **d100** and shows the outcome.</li>
          <li>Camps every 4 depths let you retire; permadeath & tombstones apply.</li>
        </ul>
        <div class="divider"></div>
        <h2>Tombstones</h2>
        <div class="tombstones" id="tombstones">—</div>
      </aside>
    </main>

    <p class="hint" style="margin-top:10px">Saves to localStorage. Token: <b>FAKE</b>.</p>
  </div>

  <!-- Dice Modal -->
  <div class="modal" id="diceModal" aria-modal="true" role="dialog">
    <div class="sheet">
      <h3 id="mTitle">—</h3>
      <div class="sub" id="mSubtitle">—</div>
      <div class="row" style="align-items:center;gap:14px">
        <div class="die" id="mDie" role="button" aria-label="Roll d100"><span class="value">d100</span><span class="label">d100</span></div>
        <div>
          <div id="mDC" class="hint">—</div>
          <div id="mBonus" class="hint">—</div>
        </div>
      </div>
      <div class="result" id="mResult" style="display:none">—</div>
      <div class="row" style="margin-top:12px;justify-content:flex-end">
        <button id="mClose" style="display:none">Continue</button>
        <button id="mCancel">Cancel</button>
      </div>
    </div>
  </div>

<script>
(function(){
  // ---------- Helpers & Storage ----------
  const $ = sel => document.querySelector(sel);
  const fmtMinor = (m) => `${(m/100).toFixed(2)} FAKE`;
  const store = {
    key: 'rc-web-d100-long-v1',
    load(){ try{ return JSON.parse(localStorage.getItem(this.key)||'{}'); }catch(_){ return {}; } },
    save(obj){ localStorage.setItem(this.key, JSON.stringify(obj)); }
  };

  // ---------- Global State ----------
  const state = {
    walletMinor: 0,
    entryFeeMinorBase: 500,
    pass: null,
    run: null,        // {hp,resolve,light,rations,gold,depth,alive,flags:Set,inv:{},thread:{id,stage}}
    tombstones: [],
    pendingCheck: null // { text, dc, bonus, bonusDesc, resolve(success, run) }
  };
  Object.assign(state, store.load());
  if(!Array.isArray(state.tombstones)) state.tombstones = [];

  function persist(){ store.save({ walletMinor: state.walletMinor, tombstones: state.tombstones }); }

  // ---------- Run Model ----------
  function newRun(runId){
    return {
      runId, depth:0, hp:10, resolve:5, light:3, rations:3, gold:0,
      alive:true, flags:new Set(),
      inv:{ torch:1, bandage:1, lockpick:0, herbs:0, relic:0 }, // starters
      log:[], scenario:null, thread: pickThread()
    };
  }
  function isCampDepth(d){ return d>0 && d%4===0; }
  function addLog(rs, msg, cls){ rs.log.push(`<span class="${cls||''}">${msg}</span>`); }

  // ---------- Threads (coherent arcs) with 20 stages each ----------
  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  function vaultStages(){
    // Act I: Approach (1-5), Act II: Entry (6-10), Act III: Depths (11-16), Act IV: Heart (17-20)
    return [
      {t:'Old Map & Distant Spurs',        d:()=>`An inked map leads you across ${pick(['stony spurs','wind-cut mesas','lichen hills'])}. Find the first waystone.` ,tags:['Vault','Trail']},
      {t:'Echoing Gulch',                  d:()=>`A gulch funnels sound; rivals might hear you. Skirt the rim or risk the floor.` ,tags:['Vault','Gulch']},
      {t:'Fallen Menhirs',                 d:()=>`Toppled stones hint at an approach. Pressure marks suggest old mechanisms.` ,tags:['Vault','Menhirs']},
      {t:'Thorned Cut',                    d:()=>`A short cut crawls with thorns. Light is fading.` ,tags:['Vault','Thicket']},
      {t:'Overwatch Ridge',                d:()=>`From a ridge you glimpse a stone face half-buried. The door can’t be far.` ,tags:['Vault','Survey']},

      {t:'The Sealed Door',                d:()=>`Sigils web the door. A grate whistles nearby. Entry demands craft—or force.` ,tags:['Vault','Ward']},
      {t:'Breather Shafts',                d:()=>`Warm air sighs from vents. You might squeeze through, if careful.` ,tags:['Vault','Vent']},
      {t:'Whispering Statues',             d:()=>`Hooded statues line the approach with hollow eyes.` ,tags:['Vault','Guardians']},
      {t:'Rust-locked Wedges',              d:()=>`Iron wedges jam a service hatch. Tools would help.` ,tags:['Vault','Hatch']},
      {t:'First Descent',                  d:()=>`Steps plunge into stale dark. The air tastes of copper.` ,tags:['Vault','Stairs']},

      {t:'Hall of Plates',                 d:()=>`Floor plates rest uneven. Some crackle faintly.` ,tags:['Vault','Trap']},
      {t:'Dart Gallery',                   d:()=>`Pitted walls at shoulder height give you pause.` ,tags:['Vault','Trap']},
      {t:'Mirror Antechamber',             d:()=>`Mirrors distort depth. Light might reveal seams.` ,tags:['Vault','Puzzle']},
      {t:'Weeping Ceiling',                d:()=>`Moisture drips. The stone groans; watch for sinkholes.` ,tags:['Vault','Hazard']},
      {t:'Backdoor Chute',                 d:()=>`A narrow chute drops into darkness—fast but risky.` ,tags:['Vault','Shortcut']},
      {t:'Glyph-lock',                     d:()=>`A plinth bears a glyph-lock. Wrong sequence will bite.` ,tags:['Vault','Lock']},

      {t:'Antechamber of Echoes',          d:()=>`Footfalls return too quickly. Hidden hollows surround you.` ,tags:['Vault','Echo']},
      {t:'The Relic’s Guard',              d:()=>`Statues frame a dais. A shard hums like a bee-hive.` ,tags:['Vault','Relic']},
      {t:'Counterweight Riddle',           d:()=>`Sandbags lie rotted. The mechanism still ticks somewhere.` ,tags:['Vault','Mechanism']},
      {t:'Break or Bypass',                d:()=>`One last test: seize the shard or trick the guardians.` ,tags:['Vault','Decision']},
    ];
  }

  function caravanStages(){
    return [
      {t:'Smoke on the Road',              d:()=>`A caravan smolders; raiders lurk. Survivors may hide nearby.`, tags:['Road','Raiders']},
      {t:'Broken Axles',                   d:()=>`Axles and crates lie scattered. Tracks veer toward a ravine.`, tags:['Ravine','Tracks']},
      {t:'Scout the Verge',                d:()=>`Scrub offers cover. A signal could draw attention—good or bad.`, tags:['Signal','Scrub']},
      {t:'Night Watch',                    d:()=>`Coyotes yip. Torches bob in the distance.`, tags:['Night','Watch']},
      {t:'Trail the Raiders',              d:()=>`Footprints thicken to a path. A camp can’t be far.`, tags:['Trail','Raiders']},

      {t:'Ravine Overlook',                d:()=>`Below, raiders dine. You note sentry routes.`, tags:['Overlook','Ambush']},
      {t:'Sabotage the Tethers',           d:()=>`Pack animals are tethered near a cart.`, tags:['Sabotage','Animals']},
      {t:'Poison the Pot',                 d:()=>`A cookpot bubbles unattended. Herbs might tilt odds.`, tags:['Herbs','Poison']},
      {t:'Free the Prisoners',             d:()=>`Bound merchants huddle. Keys jingle at a post.`, tags:['Rescue','Keys']},
      {t:'Stampede Diversion',             d:()=>`A well-timed fright could scatter the camp.`, tags:['Diversion','Chaos']},

      {t:'Regroup in the Dunes',           d:()=>`Survivors straggle. You need a route home.`, tags:['Regroup','Dunes']},
      {t:'Broker Safe Passage',            d:()=>`Locals demand payment or protection.`, tags:['Truce','Toll']},
      {t:'Bridge of Ropes',                d:()=>`A rope bridge sways over a gorge.`, tags:['Bridge','Risk']},
      {t:'Shadow Pursuit',                 d:()=>`Hoofbeats behind—raiders give chase.`, tags:['Pursuit','Chase']},
      {t:'River Ford',                     d:()=>`A ford foams white. Carts creak.`, tags:['River','Ford']},
      {t:'Rain & Mud',                      d:()=>`Storms churn the road to mire.`, tags:['Weather','Mud']},

      {t:'Town Gates',                     d:()=>`Lanterns glow at the walls; guards eye the convoy.`, tags:['Town','Gate']},
      {t:'Reclaim the Wares',              d:()=>`Owners bicker over what’s left.`, tags:['Claim','Wares']},
      {t:'Guard the Market',               d:()=>`Rumors draw thieves; one last watch.`, tags:['Market','Guard']},
      {t:'Honor Paid',                     d:()=>`The caravan survives; rewards await.`, tags:['Honor','Reward']},
    ];
  }

  function plagueStages(){
    return [
      {t:'Sickly Village',                 d:()=>`Coughs echo; an ill wind blows from the well.`, tags:['Fen','Village']},
      {t:'Symptoms & Rumors',              d:()=>`Stories point to the tannery; contradictions abound.`, tags:['Rumor','Leads']},
      {t:'Quarantine Tents',               d:()=>`A green tent city stinks of poultice.`, tags:['Quarantine','Order']},
      {t:'Herb-Gathering',                 d:()=>`Herbs dot the marsh; you know some, others you guess.`, tags:['Herbs','Marsh']},
      {t:'Well Inspection',                d:()=>`A rope creaks; coins glint below.`, tags:['Well','Inspect']},

      {t:'Tannery Vents',                  d:()=>`Sweet fumes coil from vents.`, tags:['Tannery','Vents']},
      {t:'Waste Channels',                 d:()=>`Slime trails toward the river.`, tags:['Waste','Slime']},
      {t:'Foreman’s Ledger',               d:()=>`A ledger lists shipments and strange symbols.`, tags:['Ledger','Clue']},
      {t:'Find the Source',                d:()=>`Barrels leak froth under canvas.`, tags:['Source','Barrels']},
      {t:'Seal the Vats',                  d:()=>`Hot tar and planks might stifle fumes.`, tags:['Seal','Tar']},

      {t:'Brewroom Setup',                 d:()=>`Alembics rattle; ratios matter.`, tags:['Brew','Ratios']},
      {t:'Torchlit Distillation',          d:()=>`Steady heat wins the day—if you avoid flare-ups.`, tags:['Torch','Heat']},
      {t:'Test Doses',                     d:()=>`Volunteers line up; ethics blur.`, tags:['Test','Dose']},
      {t:'Triage',                          d:()=>`Who gets medicine first?`, tags:['Triage','Crowd']},
      {t:'Supply Run',                     d:()=>`Masks, water, and wraps run low.`, tags:['Supply','Risk']},
      {t:'Backlash',                        d:()=>`Accusations fly; fear needs calming.`, tags:['Backlash','Fear']},

      {t:'Relief Routes',                  d:()=>`You chart door-to-door aid.`, tags:['Relief','Route']},
      {t:'Crowd Control',                  d:()=>`A crush at the square—hold the line.`, tags:['Crowd','Order']},
      {t:'Clean Water Plan',               d:()=>`Rig filters and boil sites.`, tags:['Water','Plan']},
      {t:'Plague Eases',                   d:()=>`Numbers drop; gratitude rises.`, tags:['Relief','Thanks']},
    ];
  }

  const Threads = {
    vault:   { name:'Ancient Vault',   stages: vaultStages() },
    caravan: { name:'Caravan Rescue',  stages: caravanStages() },
    plague:  { name:'Plague in the Fen', stages: plagueStages() }
  };
  function pickThread(){
    const id = pick(['vault','caravan','plague']);
    return { id, stage:0 };
  }

  // ---------- Elements ----------
  const elBal = $('#balance'), elEntry = $('#entryFee'), elPass = $('#pass'),
        elStart = $('#btnStart'), elFaucet = $('#btnFaucet'), elWithdraw = $('#btnWithdraw'),
        elRetire = $('#btnRetire'), elCampRow = $('#campRow'), elChoices = $('#choices'),
        elLog = $('#log'), elTombs = $('#tombstones'),
        sHP=$('#sHP'), sRV=$('#sRV'), sL=$('#sL'), sR=$('#sR'), sG=$('#sG'), sD=$('#sD'),
        scBox = $('#scenarioBox'), scTitle=$('#scTitle'), scText=$('#scText'), scTags=$('#scTags'),
        invRow=$('#invRow'), invText=$('#invText'), btnBandage=$('#btnUseBandage'), btnTorch=$('#btnUseTorch');

  // Modal
  const modal = $('#diceModal'), mTitle=$('#mTitle'), mSubtitle=$('#mSubtitle'),
        mDie=$('#mDie'), mVal=()=>mDie.querySelector('.value'), mDC=$('#mDC'), mBonus=$('#mBonus'),
        mResult=$('#mResult'), mClose=$('#mClose'), mCancel=$('#mCancel');

  function openModal(){ modal.classList.add('show'); mResult.style.display='none'; mClose.style.display='none'; }
  function closeModal(){ modal.classList.remove('show'); }

  function dynamicEntryFee(){ const jitter = Math.floor(Math.random()*50); return Math.max(100, state.entryFeeMinorBase + jitter); }
  let lastFee = dynamicEntryFee();
  function updateWallet(){ elBal.textContent = `Balance: ${fmtMinor(state.walletMinor)}`; }

  function invString(inv){
    const parts = []; for (const [k,v] of Object.entries(inv)) if(v>0) parts.push(`${k}×${v}`);
    return parts.length? parts.join(', ') : '—';
  }

  function refreshUI(){
    elEntry.textContent = `Entry fee: ${fmtMinor(lastFee)}`;
    elPass.textContent = state.pass ? `Character Pass #${state.pass.runId}` : 'No Character Pass';
    updateWallet();

    if(!state.run){
      [sHP,sRV,sL,sR,sG,sD].forEach(x=>x.textContent='—');
      elLog.innerHTML=''; elChoices.innerHTML=''; elCampRow.style.display='none'; scBox.style.display='none';
      invRow.style.display='none'; btnBandage.style.display='none'; btnTorch.style.display='none';
      return;
    }
    const rs = state.run;
    sHP.textContent = rs.hp; sRV.textContent=rs.resolve; sL.textContent=rs.light; sR.textContent=rs.rations; sG.textContent=rs.gold; sD.textContent=rs.depth;
    elLog.innerHTML = rs.log.slice(-200).map(x=>`• ${x}`).join('<br>');
    elCampRow.style.display = (isCampDepth(rs.depth) && rs.alive) ? 'flex':'none';

    invRow.style.display='flex';
    invText.textContent = `Items: ${invString(rs.inv)}`;
    btnBandage.style.display = rs.inv.bandage>0 ? 'inline-flex':'none';
    btnTorch.style.display = rs.inv.torch>0 ? 'inline-flex':'none';

    if(rs.scenario){
      scBox.style.display='block';
      scTitle.textContent = rs.scenario.title;
      scText.textContent  = rs.scenario.text;
      scTags.innerHTML    = rs.scenario.tags.map(t=>`<span class="tag">${t}</span>`).join('');
    } else scBox.style.display='none';
  }

  // Inventory use
  btnBandage.onclick = ()=>{ const r=state.run; if(!r||r.inv.bandage<=0||!r.alive) return; r.inv.bandage--; r.hp=Math.min(r.hp+2,12); addLog(r,'You use a bandage (+2 HP).','good'); refreshUI(); };
  btnTorch.onclick   = ()=>{ const r=state.run; if(!r||r.inv.torch<=0||!r.alive) return; r.inv.torch--; r.light+=1; addLog(r,'You light a torch (+1 Light).','good'); refreshUI(); };

  // ---------- Scenario + Choices ----------
  function scenarioFor(rs){
    const t = Threads[rs.thread.id]; const st = Math.min(rs.thread.stage, t.stages.length-1);
    const node = t.stages[st];
    return { title:`${t.name} — ${node.t}`, text: node.d(rs), tags:[t.name, `Stage ${st+1}`].concat(node.tags||[]), threadId: rs.thread.id, stage: st };
  }

  // DC helpers per stage + scaling
  const EZ   = (base,rs)=> Math.max(30, base + Math.floor(rs.depth/3) - 5);
  const MED  = (base,rs)=> Math.min(80, base + Math.floor(rs.depth/2));
  const HARD = (base,rs)=> Math.min(95, base + Math.floor(rs.depth*0.8));
  const WILD = (base,rs)=> Math.min(99, base + rs.depth);

  // Bonuses from context/items
  const bonusTorch   = (r)=> r.light>0 ? 5 : 0;
  const bonusResolve = (r)=> Math.max(0, r.resolve-5);
  const bonusPick    = (r)=> r.inv.lockpick>0 ? 10 : 0;
  const bonusHerbs   = (r)=> r.inv.herbs>0 ? 8 : 0;

  function choicesFor(rs, sc){
    // 4 options vary by stage: safe / tactical / risky / wild
    const acts = [];
    const base = 50; // starting reference, then adjusted
    const depthBump = Math.min(10, Math.floor(rs.depth/4));
    const easy  = EZ(base - 5 - depthBump, rs);
    const mid   = MED(base + 5, rs);
    const hard  = HARD(base + 15, rs);
    const wild  = WILD(base + 25, rs);

    // Thread-specific text + effects (lightweight, varied, coherent)
    const push = (text, dc, bonus, bonusDesc, on) => acts.push({ text, dc, bonus, bonusDesc, resolve:on });

    if(sc.threadId==='vault'){
      switch(sc.stage%5){
        case 0:
          push('Survey and mark safe ground', easy, bonusTorch, '+5 Light', (ok,r)=> ok ? (r.resolve++, addLog(r,'Calm planning pays (+1 Resolve).','good')) : (r.hp--, addLog(r,'Hidden edge cuts (-1 HP).','bad')));
          push('Tail rival footprints', mid, bonusResolve, '+Resolve bonus', (ok,r)=> ok ? (r.gold+=2, addLog(r,'Find a dropped purse (+2 gold).','good')) : (r.rations=Math.max(0,r.rations-1), addLog(r,'Lose time and food (-1 rations).','bad')));
          push('Force a faster route', hard, null, '', (ok,r)=> ok ? (r.light++, addLog(r,'Beat nightfall (+1 Light).','good')) : (r.hp-=2, addLog(r,'Twisted ankle (-2 HP).','bad')));
          push('Carve a new shortcut', wild, null, '', (ok,r)=> ok ? (r.inv.torch++, addLog(r,'Find resinous wood (+1 torch).','good')) : (r.hp-=3, addLog(r,'Scree slide (-3 HP).','bad')));
          break;
        case 1:
          push('Study sigils for weaknesses', mid, bonusTorch, '+5 Light', (ok,r)=> ok ? (r.flags.add('ward_softened'), addLog(r,'Ward weak points mapped.','good')) : (r.hp-=2, addLog(r,'Arc shock (-2 HP).','bad')));
          push('Pick the side grate', easy, bonusPick, '+10 Lockpick', (ok,r)=> ok ? (r.inv.lockpick=Math.max(0,r.inv.lockpick-1), r.light++, addLog(r,'Grate yields (+1 Light, -1 lockpick).','good')) : (r.inv.lockpick=Math.max(0,r.inv.lockpick-1), addLog(r,'Pick snaps.','bad')));
          push('Lever the door', hard, null, '', (ok,r)=> ok ? (r.gold+=3, addLog(r,'Cache exposed (+3 gold).','good')) : (r.hp-=3, addLog(r,'Lever kickback (-3 HP).','bad')));
          push('Intimidate the statues', wild, bonusResolve, '+Resolve bonus', (ok,r)=> ok ? (r.flags.add('statues_wary'), addLog(r,'Stone regards you warily.','good')) : (r.hp-=4, addLog(r,'Stone animus (-4 HP).','bad')));
          break;
        case 2:
          push('Probe plates with pole & light', easy, (r)=>bonusTorch(r)+2, '+5 Light, +2 tool', (ok,r)=> ok ? (r.inv.torch=Math.max(0,r.inv.torch-1), r.rations++, addLog(r,'Safe path (+1 rations, -1 torch).','good')) : (r.hp--, addLog(r,'Soot cough (-1 HP).','bad')));
          push('Shadow-step the darts', mid, null, '', (ok,r)=> ok ? (r.resolve++, addLog(r,'You move like water (+1 Resolve).','good')) : (r.hp-=2, addLog(r,'Dart graze (-2 HP).','bad')));
          push('Sprint the gauntlet', hard, null, '', (ok,r)=> ok ? (r.gold+=2, addLog(r,'Quick haul (+2 gold).','good')) : (r.hp-=3, addLog(r,'Panel collapse (-3 HP).','bad')));
          push('Drop through the chute', wild, null, '', (ok,r)=> ok ? (r.flags.add('backdoor'), addLog(r,'Back passage found!','good')) : (r.hp-=4, addLog(r,'Hard tumble (-4 HP).','bad')));
          break;
        case 3:
          push('Decode glyph-lock', mid, bonusResolve, '+Resolve bonus', (ok,r)=> ok ? (r.gold+=3, addLog(r,'Mechanism hums (+3 gold).','good')) : (r.hp-=2, addLog(r,'Glyph bite (-2 HP).','bad')));
          push('Use sandbag counterweight', easy, null, '', (ok,r)=> ok ? (r.resolve++, addLog(r,'Tension equalized (+1 Resolve).','good')) : (r.hp--, addLog(r,'Rope lash (-1 HP).','bad')));
          push('Bypass with backdoor', hard, null, '', (ok,r)=> ok ? (r.light++, addLog(r,'Shortcut saves time (+1 Light).','good')) : (r.hp-=3, addLog(r,'Dead end bruise (-3 HP).','bad')));
          push('Risk guardian glare', wild, null, '', (ok,r)=> ok ? (r.gold+=4, addLog(r,'They hold still (+4 gold).','good')) : (r.hp-=5, addLog(r,'They move (-5 HP).','bad')));
          break;
        case 4:
          push('Lift relic with tongs', mid, null, '', (ok,r)=> ok ? (r.inv.relic++, addLog(r,'Relic shard claimed (+1 relic).','good')) : (r.hp-=2, addLog(r,'Runes nip (-2 HP).','bad')));
          push('Swap with decoy weight', hard, null, '', (ok,r)=> ok ? (r.gold+=6, addLog(r,'Perfect trade (+6 gold).','good')) : (r.hp-=3, addLog(r,'Pedestal jerk (-3 HP).','bad')));
          push('Appease with light', easy, bonusTorch, '+5 Light', (ok,r)=> ok ? (r.resolve++, addLog(r,'Glares soften (+1 Resolve).','good')) : (r.hp--, addLog(r,'Shadows press (-1 HP).','bad')));
          push('Grab & dash', wild, null, '', (ok,r)=> ok ? (r.inv.relic++, r.gold+=4, addLog(r,'Snatch & sprint (+1 relic, +4 gold).','good')) : (r.hp-=5, addLog(r,'Statues animate (-5 HP).','bad')));
          break;
      }
    } else if(sc.threadId==='caravan'){
      push('Search for survivors', easy, bonusTorch, '+5 Light', (ok,r)=> ok ? (r.inv.bandage++, addLog(r,'You find supplies (+1 bandage).','good')) : (r.hp--, addLog(r,'Collapsing wagon (-1 HP).','bad')));
      push('Trail raiders quietly', mid, bonusResolve, '+Resolve bonus', (ok,r)=> ok ? (r.flags.add('raider_trail'), addLog(r,'You mark their route.','good')) : (r.rations=Math.max(0,r.rations-1), addLog(r,'Lose time (-1 rations).','bad')));
      push('Set a counter-ambush', hard, null, '', (ok,r)=> ok ? (r.gold+=4, addLog(r,'Loot reclaimed (+4 gold).','good')) : (r.hp-=3, addLog(r,'They spot you (-3 HP).','bad')));
      push('Stampede diversion', wild, null, '', (ok,r)=> ok ? (r.resolve++, addLog(r,'Chaos favors you (+1 Resolve).','good')) : (r.hp-=4, addLog(r,'It tramples you (-4 HP).','bad')));
    } else { // plague
      push('Question the healer', easy, null, '', (ok,r)=> ok ? (r.inv.herbs++, addLog(r,'Herbs acquired (+1 Herbs).','good')) : (r.resolve=Math.max(3,r.resolve-1), addLog(r,'Fears grow (-1 Resolve).','bad')));
      push('Inspect vents with torch', mid, bonusTorch, '+5 Light', (ok,r)=> ok ? (r.flags.add('found_source'), addLog(r,'Source located.','good')) : (r.hp-=2, addLog(r,'Fumes sting (-2 HP).','bad')));
      push('Brew a tonic', hard, bonusHerbs, '+8 Herbs', (ok,r)=> ok ? (r.inv.herbs=Math.max(0,r.inv.herbs-1), r.flags.add('tonic'), addLog(r,'A tonic is bottled (-1 Herbs).','good')) : (r.hp-=2, addLog(r,'Batch curdles (-2 HP).','bad')));
      push('Rally the crowd', wild, bonusResolve, '+Resolve bonus', (ok,r)=> ok ? (r.flags.add('hero_of_fen'), addLog(r,'Cheers rise—order restored.','good')) : (r.hp-=3, addLog(r,'Bottles fly (-3 HP).','bad')));
    }
    return acts;
  }

  function renderChoices(rs, choices){
    elChoices.innerHTML='';
    choices.forEach(c=>{
      const btn=document.createElement('button');
      const req=document.createElement('span'); req.className='req';
      const bonusPreview = c.bonusDesc ? ` · ${c.bonusDesc}` : '';
      req.textContent=`DC ${c.dc}${bonusPreview}`;
      btn.appendChild(document.createTextNode(c.text));
      btn.appendChild(req);
      btn.onclick=()=> openDiceFor(c);
      elChoices.appendChild(btn);
    });
  }

  // ---------- Dice modal flow ----------
  function openDiceFor(check){
    const rs = state.run;
    state.pendingCheck = check;
    const bonus = check.bonus? check.bonus(rs) : 0;
    mTitle.textContent = 'Resolve Action';
    mSubtitle.textContent = check.text;
    mDC.textContent = `Difficulty: DC ${check.dc}`;
    mBonus.textContent = bonus ? `Bonus: +${bonus}` : 'Bonus: —';
    mVal().textContent = 'd100';
    mResult.style.display='none';
    mClose.style.display='none';
    openModal();
  }

  function animateRoll(done){
    mDie.classList.add('rolling');
    let t=0; const dur=900; const step=60;
    const tick = ()=>{
      t+=step; mVal().textContent = (1+Math.floor(Math.random()*100)).toString().padStart(2,'0');
      if(t>=dur){
        const final = 1+Math.floor(Math.random()*100);
        mVal().textContent = final.toString().padStart(2,'0');
        mDie.classList.remove('rolling');
        done(final);
      } else setTimeout(tick, step);
    };
    tick();
  }

  mDie.addEventListener('click', ()=>{
    const rs = state.run; if(!rs || !rs.alive) return;
    const chk = state.pendingCheck; if(!chk) return;
    // Prevent multiple rolls
    if(mDie.classList.contains('rolling')) return;
    animateRoll((roll)=>{
      const bonus = chk.bonus? chk.bonus(rs):0;
      const total = roll + bonus;
      const success = total >= chk.dc;
      // Show outcome in modal
      mResult.className = 'result ' + (success?'success':'fail');
      mResult.textContent = `${success?'Success':'Fail'} — roll ${roll}${bonus?` + ${bonus}`:''} = ${total} vs DC ${chk.dc}`;
      mResult.style.display='block';
      mClose.style.display='inline-flex';

      // Apply effects
      chk.resolve(success, rs);
      addLog(rs, `Action: ${chk.text}. ${success?'Success':'Fail'} (${roll}${bonus?`+${bonus}`:''}=${total} vs ${chk.dc}).`, success?'good':'bad');
      state.pendingCheck = null;
      refreshUI();
    });
  });

  mClose.addEventListener('click', ()=>{ closeModal(); afterPick(); });
  mCancel.addEventListener('click', ()=>{ closeModal(); state.pendingCheck=null; refreshUI(); });

  // ---------- Step / Flow ----------
  function nextScenario(rs){
    const sc = scenarioFor(rs);
    rs.scenario = sc;
    const options = choicesFor(rs, sc);
    renderChoices(rs, options.slice(0,4));
  }

  function advanceThread(rs){
    const t = Threads[rs.thread.id];
    if(rs.thread.stage < t.stages.length-1){
      rs.thread.stage++;
    } else {
      // Completed arc: grant reward and roll a new random thread
      rs.gold += 10;
      addLog(rs,'Arc complete (+10 gold).','good');
      rs.thread = pickThread();
      rs.thread.stage = 0;
    }
  }

  function step(){
    const rs = state.run; if(!rs || !rs.alive) return;
    rs.depth += 1;
    if(Math.random()<Math.min(0.45, rs.depth*0.02)){ rs.hp -= 1; addLog(rs,'Fatigue nips at you (-1 HP).','bad'); }
    if(isCampDepth(rs.depth)){ addLog(rs,'You reach a camp. You can retire safely here.'); }
    nextScenario(rs);
    refreshUI();
  }

  function afterPick(){
    const rs = state.run; if(!rs) return;
    if(rs.hp<=0){ rs.alive=false; addLog(rs, `You die at depth ${rs.depth}. Unbanked loot lost (${rs.gold} gold). Pass burned.`, 'bad');
      state.tombstones.unshift({ runId: rs.runId, depth: rs.depth, gold: rs.gold, time: Date.now() });
      if(state.tombstones.length>50) state.tombstones.pop();
      state.pass=null; state.run=null; persist(); renderTombs(); refreshUI(); return; }
    advanceThread(rs);
    step();
  }

  function renderTombs(){
    if(!state.tombstones.length){ elTombs.textContent='—'; return; }
    elTombs.innerHTML = state.tombstones.map(t=>{
      const d = new Date(t.time).toLocaleString();
      return `RIP <b>#${t.runId}</b> — depth ${t.depth}, gold ${t.gold} <span class="muted">(${d})</span>`;
    }).join('<br>');
  }

  // ---------- Controls ----------
  $('#btnFaucet').onclick = ()=>{ state.walletMinor += 2000; persist(); updateWallet(); };
  $('#btnWithdraw').onclick = ()=>{ state.walletMinor = Math.max(0, state.walletMinor-500); persist(); updateWallet(); };

  $('#btnStart').onclick = ()=>{
    if(state.pass || state.run) return;
    const fee = lastFee; if(state.walletMinor < fee){ alert('Insufficient funds for entry fee. Use Add Test Coins.'); return; }
    state.walletMinor -= fee; persist(); updateWallet();
    const runId = Math.floor(Date.now()/1000).toString(36);
    state.pass = { runId, entryFeeMinor: fee };
    state.run = newRun(runId);
    addLog(state.run, `Run started. Entry fee: ${fmtMinor(fee)}.`);
    step();
    lastFee = dynamicEntryFee(); refreshUI();
  };

  $('#btnRetire').onclick = ()=>{
    const rs = state.run; if(!rs) return;
    if(!isCampDepth(rs.depth)){ addLog(rs,'You cannot retire here. Find a camp.'); refreshUI(); return; }
    const relicPayout = (rs.inv.relic||0)*8; rs.inv.relic=0;
    const payoutMinor = (rs.gold + relicPayout) * 50; // 1 gold = 0.50 FAKE
    state.walletMinor += payoutMinor; persist(); updateWallet();
    addLog(rs, `You retire with ${rs.gold} gold + relics (${relicPayout} gold) → ${fmtMinor(payoutMinor)}.`, 'good');
    rs.alive=false; state.pass=null; state.run=null; refreshUI();
  };

  // ---------- Init ----------
  function initTombs(){ renderTombs(); }
  initTombs(); refreshUI();

})();
</script>
</body>
</html>
