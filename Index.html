<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Roguechain — d100 Dice, Gear, Tokens (Mobile)</title>
<style>
  :root{
    --bg:#0b0f14;--panel:#0f1620;--panel2:#0d141d;--ink:#e6edf3;--muted:#9aa5b1;--accent:#72a1ff;--good:#42d392;--bad:#ff6b6b;--edge:#1f2a37;
    --shadow: 0 8px 30px rgba(0,0,0,.45)
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink);-webkit-tap-highlight-color:transparent}
  .wrap{max-width:1024px;margin:0 auto;padding:16px}
  header{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin-bottom:12px}
  .brand{font-weight:800;letter-spacing:.3px;font-size:clamp(16px,2.5vw,20px)}
  .wallet{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .pill{background:var(--panel);border:1px solid var(--edge);padding:8px 10px;border-radius:10px;display:flex;gap:8px;align-items:center;font-size:14px}
  button{background:var(--panel2);border:1px solid var(--edge);border-radius:12px;padding:10px 14px;color:var(--ink);cursor:pointer;font-weight:600}
  button:active{transform:scale(0.98)}
  button:hover{border-color:#315a9f}
  button.primary{background:#1b2736;border-color:#315a9f}
  main{display:grid;grid-template-columns:1.2fr .8fr;gap:12px}
  @media (max-width:920px){main{grid-template-columns:1fr}}
  .card{background:var(--panel);border:1px solid var(--edge);border-radius:14px;padding:12px;box-shadow:var(--shadow)}
  h2{margin:0 0 8px;font-size:18px}
  .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin:8px 0}
  @media (max-width:520px){.stats{grid-template-columns:repeat(2,1fr)}}
  .stat{background:var(--panel2);border:1px solid var(--edge);border-radius:12px;padding:8px;text-align:center;font-size:14px}
  .choices{display:flex;flex-direction:column;gap:8px;margin-top:8px}
  .choices button{width:100%;text-align:left;display:flex;justify-content:space-between;align-items:center;gap:10px}
  .log{max-height:320px;overflow:auto;background:var(--panel2);border:1px solid var(--edge);border-radius:12px;padding:10px;font:13px/1.5 ui-monospace,Consolas,Menlo,monospace}
  .log .good{color:var(--good)} .log .bad{color:var(--bad)}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .hint{color:var(--muted);font-size:12px}
  .divider{height:1px;background:var(--edge);margin:8px 0}
  .tombstones{font:13px/1.4 ui-monospace,Consolas,Menlo,monospace}
  .muted{color:var(--muted)}

  .tabs{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
  .tab{padding:8px 12px;border:1px solid var(--edge);border-radius:999px;background:var(--panel2);cursor:pointer}
  .tab.active{background:#1b2736;border-color:#315a9f}

  .scenario{background:var(--panel2);border:1px solid var(--edge);border-radius:12px;padding:10px}
  .scenario h3{margin:0 0 6px;font-size:16px}
  .scenario p{margin:0;color:#c8d0d8}
  .tag{display:inline-block;background:#1a2432;border:1px solid #2a3a52;border-radius:999px;padding:3px 8px;margin-right:6px;font-size:11px;color:#9fb4d6}

  /* Inventory grid */
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
  @media (max-width:600px){.grid{grid-template-columns:1fr}}
  .item{display:flex;justify-content:space-between;align-items:center;background:var(--panel2);border:1px solid var(--edge);border-radius:12px;padding:8px}

  /* Dice modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
  .modal.show{display:flex}
  .modal .sheet{max-width:560px;width:100%;background:var(--panel);border:1px solid var(--edge);border-radius:14px;padding:16px;box-shadow:var(--shadow)}
  .modal h3{margin:0 0 6px;font-size:18px}
  .modal .sub{color:var(--muted);font-size:13px;margin-bottom:8px}
  .die{width:100px;height:100px;border-radius:14px;background:radial-gradient(60% 60% at 50% 45%,#1a2432 0%,#0f1620 100%);border:2px solid var(--edge);
       display:flex;align-items:center;justify-content:center;font:800 26px/1 ui-monospace,Consolas;color:#b8d3ff;position:relative;user-select:none}
  .die .label{position:absolute;bottom:4px;left:6px;font:10px/1.2 ui-monospace;color:#9aa5b1}
  .die.rolling{animation:shake .9s ease-in-out}
  @keyframes shake{0%{transform:rotate(0)}25%{transform:rotate(6deg)}50%{transform:rotate(-6deg)}75%{transform:rotate(3deg)}100%{transform:rotate(0)}}
  .outcome{margin-top:12px;background:var(--panel2);border:1px solid var(--edge);border-radius:12px;padding:10px}
  .result{font-weight:800;margin-top:8px}
  .good{color:var(--good)} .bad{color:var(--bad)}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">Roguechain — d100 Dice • Gear • Tokens</div>
      <div class="wallet">
        <div class="pill" id="balance">Balance: 0.00 FAKE</div>
        <button id="btnFaucet">Add Test Coins</button>
        <button id="btnWithdraw">Withdraw 5.00</button>
      </div>
    </header>

    <div class="tabs">
      <div id="tabPlay" class="tab active">Play</div>
      <div id="tabInventory" class="tab">Inventory & Loadout</div>
    </div>

    <main>
      <!-- PLAY CARD -->
      <section class="card" id="playCard">
        <h2>Adventure</h2>
        <div class="row">
          <button id="btnStart" class="primary">Start Run (Pay Entry Fee / Use Amulet)</button>
          <div class="pill" id="entryFee">Entry fee: 5.00 FAKE</div>
          <div class="pill" id="pass">No Character Pass</div>
        </div>

        <div class="stats">
          <div class="stat">HP <div id="sHP">—</div></div>
          <div class="stat">Stamina <div id="sST">—</div></div>
          <div class="stat">Nutrition <div id="sNU">—</div></div>
          <div class="stat">Defense <div id="sDF">—</div></div>
          <div class="stat">Tokens <div id="sTK">—</div></div>
          <div class="stat">Depth <div id="sD">—</div></div>
        </div>

        <div id="campRow" class="row" style="display:none">
          <button id="btnRetire">Retire at Camp (Bank Tokens)</button>
          <span class="hint">Camps appear every 4 depths. Retire to bank your haul to wallet.</span>
        </div>

        <div class="scenario" id="scenarioBox" style="display:none">
          <div class="row" style="justify-content:space-between;align-items:center">
            <h3 id="scTitle" style="margin:0">—</h3>
            <div id="scTags"></div>
          </div>
          <p id="scText">—</p>
        </div>

        <div class="divider"></div>
        <div class="choices" id="choices"></div>

        <div class="divider"></div>
        <div class="log" id="log"></div>
      </section>

      <!-- INVENTORY CARD -->
      <section class="card" id="invCard" style="display:none">
        <h2>Your Inventory & Loadout</h2>
        <div class="row">
          <div class="pill" id="amuletInfo">Amulet of Life: none</div>
          <div class="pill" id="entryInfo">Free entry today: no</div>
        </div>
        <div class="divider"></div>

        <h3 style="margin-top:0">Weapons</h3>
        <div id="weaponsGrid" class="grid"></div>
        <div class="divider"></div>

        <h3>Armour</h3>
        <div id="armoursGrid" class="grid"></div>
        <div class="divider"></div>

        <h3>Trinkets</h3>
        <div id="trinketsGrid" class="grid"></div>
        <div class="divider"></div>

        <h3>Consumables</h3>
        <div id="consumablesGrid" class="grid"></div>
        <p class="hint">Bandages heal HP during a run; food restores Nutrition during a run (you’ll use them when needed via scenario effects).</p>
      </section>

      <aside class="card">
        <h2>How it works</h2>
        <ul class="muted">
          <li>Pick your **loadout** first. Amulet grants **one free entry per day**.</li>
          <li>Each turn: a vivid scenario and **4 actions**. Pick first; you’ll see the **dice window** after.</li>
          <li>We roll **d100** with gear bonuses hidden until the modal reveals them.</li>
          <li>Find **tokens, gear, bandages, food**, and **rare relics** like the Amulet.</li>
          <li>At camps (every 4 depths) you can **Retire** to bank tokens to your wallet.</li>
          <li>Permadeath: if you die mid-run, you lose unbanked items and tokens from that run.</li>
        </ul>
        <div class="divider"></div>
        <h2>Tombstones</h2>
        <div class="tombstones" id="tombstones">—</div>
      </aside>
    </main>

    <p class="hint" style="margin-top:10px">Saves locally (localStorage). Token: <b>FAKE</b>.</p>
  </div>

  <!-- Dice Modal -->
  <div class="modal" id="diceModal" aria-modal="true" role="dialog">
    <div class="sheet">
      <h3 id="mTitle">—</h3>
      <div class="sub" id="mSubtitle">—</div>
      <div class="row" style="align-items:center;gap:14px">
        <div class="die" id="mDie" role="button" aria-label="Roll d100"><span class="value">d100</span><span class="label">d100</span></div>
        <div>
          <div id="mDC" class="hint">Tap the die to roll</div>
          <div id="mBonus" class="hint">—</div>
        </div>
      </div>
      <div class="outcome" id="mOutcome" style="display:none">
        <div id="mResult" class="result">—</div>
        <ul id="mEffects" style="margin:6px 0 0 18px"></ul>
      </div>
      <div class="row" style="margin-top:12px;justify-content:flex-end">
        <button id="mClose" style="display:none">Continue</button>
        <button id="mCancel">Cancel</button>
      </div>
    </div>
  </div>

<script>
(function(){
  // ---------- Helpers & Storage ----------
  const $ = sel => document.querySelector(sel);
  const fmtMinor = (m) => `${(m/100).toFixed(2)} FAKE`;
  const todayStr = ()=> new Date().toISOString().slice(0,10);

  const store = {
    key: 'rc-web-d100-gear-v1',
    load(){ try{ return JSON.parse(localStorage.getItem(this.key)||'{}'); }catch(_){ return {}; } },
    save(obj){ localStorage.setItem(this.key, JSON.stringify(obj)); }
  };

  // ---------- Catalog ----------
  const WEAPONS = [
    {id:'rust_dagger', name:'Rusty Dagger', atk:2, hp:0, def:0, rarity:'common'},
    {id:'short_sword', name:'Short Sword',  atk:5, hp:0, def:0, rarity:'uncommon'},
    {id:'warblade',    name:'Warblade',     atk:10, hp:1, def:0, rarity:'rare'},
  ];
  const ARMOURS = [
    {id:'leather', name:'Leather Jerkin', def:2, hp:0, atk:0, rarity:'common'},
    {id:'chain',   name:'Chain Shirt',    def:4, hp:1, atk:0, rarity:'uncommon'},
    {id:'tower',   name:'Tower Shield',   def:6, hp:0, atk:0, rarity:'rare'},
  ];

  // ---------- Global State (persistent) ----------
  const state = {
    walletMinor: 0,
    entryFeeMinorBase: 500,
    tombstones: [],
    stash: {
      weapons: ['rust_dagger'],   // start with a dagger
      armours: ['leather'],       // start with leather
      trinkets: [],               // e.g., amulet_of_life
      consumables: { bandage: 1, food: 1 }, // starting supplies
      equip: { weapon:'rust_dagger', armour:'leather' },
      amulet: { have:false, lastUsed:'' }   // lastUsed = YYYY-MM-DD
    },
    pass: null,   // {runId, entryFeeMinor, usedAmulet:boolean}
    run: null     // (filled below)
  };
  Object.assign(state, store.load());
  if(!state.stash) state.stash = { weapons:['rust_dagger'], armours:['leather'], trinkets:[], consumables:{bandage:1,food:1}, equip:{weapon:'rust_dagger',armour:'leather'}, amulet:{have:false,lastUsed:''} };
  if(!state.stash.consumables) state.stash.consumables = {bandage:0,food:0};
  if(!state.stash.equip) state.stash.equip = { weapon: state.stash.weapons?.[0]||'rust_dagger', armour: state.stash.armours?.[0]||'leather' };
  if(!Array.isArray(state.tombstones)) state.tombstones = [];

  function persist(){ store.save({ walletMinor:state.walletMinor, tombstones:state.tombstones, stash:state.stash }); }

  // ---------- Run Model ----------
  function gearStats(){
    const w = WEAPONS.find(x=>x.id===state.stash.equip.weapon);
    const a = ARMOURS.find(x=>x.id===state.stash.equip.armour);
    return {
      atkBonus: (w?.atk||0),
      defBonus: (a?.def||0),
      hpBonus:  (w?.hp||0) + (a?.hp||0)
    };
  }

  function newRun(runId){
    const g = gearStats();
    return {
      runId,
      depth: 0,
      hp: 10 + g.hpBonus,
      stamina: 8,
      nutrition: 6,
      defense: g.defBonus,   // applied to reduce many damage types
      tokens: 0,
      alive: true,
      log: [],
      scenario: null,
      thread: pickThread(),
      gAtk: g.atkBonus
    };
  }

  function isCampDepth(d){ return d>0 && d%4===0; }
  function addLog(rs, msg, cls){ rs.log.push(`<span class="${cls||''}">${msg}</span>`); }

  // ---------- UI Elements ----------
  const elBal=$('#balance'), elEntry=$('#entryFee'), elPass=$('#pass'),
        elStart=$('#btnStart'), elFaucet=$('#btnFaucet'), elWithdraw=$('#btnWithdraw'),
        elRetire=$('#btnRetire'), elCampRow=$('#campRow'),
        elChoices=$('#choices'), elLog=$('#log'), elTombs=$('#tombstones'),
        sHP=$('#sHP'), sST=$('#sST'), sNU=$('#sNU'), sDF=$('#sDF'), sTK=$('#sTK'), sD=$('#sD'),
        scBox=$('#scenarioBox'), scTitle=$('#scTitle'), scText=$('#scText'), scTags=$('#scTags');

  // Tabs
  const tabPlay=$('#tabPlay'), tabInv=$('#tabInventory'), playCard=$('#playCard'), invCard=$('#invCard');

  // Inventory page elements
  const weaponsGrid=$('#weaponsGrid'), armoursGrid=$('#armoursGrid'), trinketsGrid=$('#trinketsGrid'), consumablesGrid=$('#consumablesGrid'),
        amuletInfo=$('#amuletInfo'), entryInfo=$('#entryInfo');

  // Modal
  const modal=$('#diceModal'), mTitle=$('#mTitle'), mSubtitle=$('#mSubtitle'),
        mDie=$('#mDie'), mVal=()=>mDie.querySelector('.value'),
        mDC=$('#mDC'), mBonus=$('#mBonus'), mOutcome=$('#mOutcome'),
        mResult=$('#mResult'), mEffects=$('#mEffects'), mClose=$('#mClose'), mCancel=$('#mCancel');

  // ---------- Wallet/Entry ----------
  function dynamicEntryFee(){ const jitter = Math.floor(Math.random()*50); return Math.max(100, state.entryFeeMinorBase + jitter); }
  let lastFee = dynamicEntryFee();
  function updateWallet(){ elBal.textContent = `Balance: ${(state.walletMinor/100).toFixed(2)} FAKE`; }
  function freeEntryAvailable(){
    return state.stash.amulet.have && state.stash.amulet.lastUsed !== todayStr();
  }

  // ---------- Tabs ----------
  function setTab(which){
    const inv = (which==='inv');
    playCard.style.display = inv ? 'none':'block';
    invCard.style.display  = inv ? 'block':'none';
    tabPlay.classList.toggle('active', !inv);
    tabInv.classList.toggle('active', inv);
    if(inv) renderInventory();
  }
  tabPlay.onclick=()=>setTab('play');
  tabInv.onclick=()=>setTab('inv');

  // ---------- Inventory rendering ----------
  function renderInventory(){
    // Amulet status
    amuletInfo.textContent = `Amulet of Life: ${state.stash.amulet.have? 'owned' : 'none'}`;
    entryInfo.textContent  = `Free entry today: ${freeEntryAvailable()? 'yes' : 'no'}`;

    const wEquipped = state.stash.equip.weapon;
    const aEquipped = state.stash.equip.armour;

    weaponsGrid.innerHTML='';
    (state.stash.weapons||[]).forEach(id=>{
      const w = WEAPONS.find(x=>x.id===id);
      if(!w) return;
      const div = document.createElement('div'); div.className='item';
      div.innerHTML = `<div><b>${w.name}</b><div class="hint">+${w.atk} attack, +${w.hp} HP</div></div>`;
      const b = document.createElement('button'); b.textContent = (wEquipped===id)?'Equipped':'Equip';
      b.onclick = ()=>{ state.stash.equip.weapon=id; persist(); renderInventory(); };
      div.appendChild(b);
      weaponsGrid.appendChild(div);
    });

    armoursGrid.innerHTML='';
    (state.stash.armours||[]).forEach(id=>{
      const a = ARMOURS.find(x=>x.id===id);
      if(!a) return;
      const div = document.createElement('div'); div.className='item';
      div.innerHTML = `<div><b>${a.name}</b><div class="hint">+${a.def} defense, +${a.hp} HP</div></div>`;
      const b = document.createElement('button'); b.textContent = (aEquipped===id)?'Equipped':'Equip';
      b.onclick = ()=>{ state.stash.equip.armour=id; persist(); renderInventory(); };
      div.appendChild(b);
      armoursGrid.appendChild(div);
    });

    trinketsGrid.innerHTML='';
    (state.stash.trinkets||[]).forEach(id=>{
      const name = (id==='amulet_of_life')?'Amulet of Life':'Unknown Trinket';
      const div = document.createElement('div'); div.className='item';
      div.innerHTML = `<div><b>${name}</b><div class="hint">${id==='amulet_of_life'?'1 free entry per day':''}</div></div>`;
      const b = document.createElement('button'); b.textContent = (id==='amulet_of_life' && freeEntryAvailable()) ? 'Free entry ready' : '—';
      b.disabled = true; div.appendChild(b);
      trinketsGrid.appendChild(div);
    });

    consumablesGrid.innerHTML='';
    const c = state.stash.consumables;
    const mk = (label, count)=>{ const d=document.createElement('div'); d.className='item'; d.innerHTML=`<div><b>${label}</b><div class="hint">x${count}</div></div>`; const b=document.createElement('button'); b.textContent='—'; b.disabled=true; d.appendChild(b); consumablesGrid.appendChild(d); };
    mk('Bandage', c.bandage||0);
    mk('Food', c.food||0);
  }

  // ---------- UI refresh ----------
  function refreshUI(){
    elEntry.textContent = `Entry fee: ${(lastFee/100).toFixed(2)} FAKE`;
    elPass.textContent = state.pass ? `Character Pass #${state.pass.runId}${state.pass.usedAmulet?' (free)': ''}` : 'No Character Pass';
    updateWallet();

    if(!state.run){
      [sHP,sST,sNU,sDF,sTK,sD].forEach(x=>x.textContent='—');
      elLog.innerHTML=''; elChoices.innerHTML=''; elCampRow.style.display='none'; scBox.style.display='none';
      return;
    }
    const rs = state.run;
    sHP.textContent=rs.hp; sST.textContent=rs.stamina; sNU.textContent=rs.nutrition; sDF.textContent=rs.defense; sTK.textContent=rs.tokens; sD.textContent=rs.depth;
    elLog.innerHTML = rs.log.slice(-200).map(x=>`• ${x}`).join('<br>');
    elCampRow.style.display = (isCampDepth(rs.depth) && rs.alive) ? 'flex':'none';

    if(rs.scenario){
      scBox.style.display='block';
      scTitle.textContent = rs.scenario.title;
      scText.textContent  = rs.scenario.text;
      scTags.innerHTML    = rs.scenario.tags.map(t=>`<span class="tag">${t}</span>`).join('');
    } else scBox.style.display='none';
  }

  // ---------- Modal helpers ----------
  function openModal(){ modal.classList.add('show'); mOutcome.style.display='none'; mClose.style.display='none'; }
  function closeModal(){ modal.classList.remove('show'); }

  function animateRoll(done){
    mDie.classList.add('rolling');
    let t=0; const dur=900; const step=60;
    const tick = ()=>{
      t+=step; mVal().textContent = (1+Math.floor(Math.random()*100)).toString().padStart(2,'0');
      if(t>=dur){
        const final = 1+Math.floor(Math.random()*100);
        mVal().textContent = final.toString().padStart(2,'0');
        mDie.classList.remove('rolling');
        done(final);
      } else setTimeout(tick, step);
    };
    tick();
  }

  // ---------- Threads / Scenarios (20-stage arcs x 3 threads) ----------
  const Threads = {
    vault: { name:'Ancient Vault', stages: [
      'Old Map & Distant Spurs','Echoing Gulch','Fallen Menhirs','Thorned Cut','Overwatch Ridge',
      'The Sealed Door','Breather Shafts','Whispering Statues','Rust-locked Wedges','First Descent',
      'Hall of Plates','Dart Gallery','Mirror Antechamber','Weeping Ceiling','Backdoor Chute',
      'Glyph-lock','Antechamber of Echoes','The Relic’s Guard','Counterweight Riddle','Break or Bypass'
    ]},
    caravan: { name:'Caravan Rescue', stages: [
      'Smoke on the Road','Broken Axles','Scout the Verge','Night Watch','Trail the Raiders',
      'Ravine Overlook','Sabotage the Tethers','Poison the Pot','Free the Prisoners','Stampede Diversion',
      'Regroup in the Dunes','Broker Safe Passage','Bridge of Ropes','Shadow Pursuit','River Ford',
      'Rain & Mud','Town Gates','Reclaim the Wares','Guard the Market','Honor Paid'
    ]},
    plague: { name:'Plague in the Fen', stages: [
      'Sickly Village','Symptoms & Rumors','Quarantine Tents','Herb-Gathering','Well Inspection',
      'Tannery Vents','Waste Channels','Foreman’s Ledger','Find the Source','Seal the Vats',
      'Brewroom Setup','Torchlit Distillation','Test Doses','Triage','Supply Run',
      'Backlash','Relief Routes','Crowd Control','Clean Water Plan','Plague Eases'
    ]}
  };
  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
  function pickThread(){ const id = pick(['vault','caravan','plague']); return { id, stage:0 }; }

  function scenarioFor(rs){
    const t = Threads[rs.thread.id]; const st = Math.min(rs.thread.stage, t.stages.length-1);
    const stageName = t.stages[st];

    // Impactful vignette text based on stage
    const vivid = (()=> {
      const deck = [
        `Two guards sprint at you with blades raised.`,
        `A bolted gate groans as more enemies gather behind.`,
        `A shadow leaps from the archway—fangs glisten.`,
        `An alarm bell starts to ring in the distance.`,
        `A narrow ledge crumbles beneath your boots.`,
        `A trap plate clicks under your heel.`,
        `A desperate captive begs for help while archers aim.`,
        `Oil lamps explode into sudden flame along the walls.`,
      ];
      return pick(deck);
    })();

    const title = `${Threads[rs.thread.id].name} — ${stageName}`;
    const text  = vivid;
    const tags  = [Threads[rs.thread.id].name, `Stage ${st+1}`];
    return { title, text, tags, threadId: rs.thread.id, stage: st };
  }

  // Build four cinematic actions. No odds shown here.
  // DC + bonuses are hidden until modal; equipment can add bonuses (weapon atk).
  function makeActions(rs, sc){
    // Base DCs scale a bit with depth & stage
    const base = 45 + Math.min(20, Math.floor(rs.depth*0.7)) + Math.floor(sc.stage/2);
    const rnd  = ()=> Math.floor(Math.random()*6)-3; // small jitter
    const atkB = rs.gAtk || 0;

    const actions = [
      { // Evasive
        text: 'Dive, roll, and sprint for an exit',
        dc: Math.min(90, base + 5 + rnd()),
        bonus: (r)=> Math.max(0, Math.floor((r.stamina-6)*1)) , // stamina above 6 helps evasive moves
        tag: 'evasion',
        onSuccess: (r, eff)=>{ eff.push('+1 Depth progress'); if(r.stamina>0) {r.stamina--; eff.push('-1 Stamina');} r.tokens += 2; eff.push('+2 tokens'); },
        onFail:    (r, eff)=>{ const dmg = Math.max(0, 2 - r.defense); r.hp -= dmg; eff.push(`-${dmg} HP (scrapes)`); if(r.nutrition>0){r.nutrition--; eff.push('-1 Nutrition');} }
      },
      { // Counter-attack
        text: 'Deflect the strike and counter with your weapon',
        dc: Math.min(95, base + 12 + rnd()),
        bonus: (r)=> atkB, // weapon attack bonus
        tag: 'attack',
        onSuccess: (r, eff)=>{ r.tokens += 4; eff.push('+4 tokens (spoils)'); if(Math.random()<0.25){ r.stamina=Math.min(r.stamina+1,10); eff.push('+1 Stamina (adrenaline)'); } },
        onFail:    (r, eff)=>{ const raw = 4; const dmg = Math.max(0, raw - r.defense); r.hp -= dmg; eff.push(`-${dmg} HP (hit through guard)`); if(Math.random()<0.4){ r.stamina=Math.max(0,r.stamina-1); eff.push('-1 Stamina'); } }
      },
      { // Acrobatics
        text: 'Flip over them and strike mid-air',
        dc: Math.min(98, base + 18 + rnd()),
        bonus: (r)=> Math.floor(atkB/2) + (r.stamina>7?2:0),
        tag: 'acrobat',
        onSuccess: (r, eff)=>{ r.tokens += 6; eff.push('+6 tokens'); if(Math.random()<0.3){ giveRandomGear(r, eff); } },
        onFail:    (r, eff)=>{ const raw = 6; const dmg = Math.max(0, raw - r.defense); r.hp -= dmg; eff.push(`-${dmg} HP (hard fall)`); r.stamina=Math.max(0,r.stamina-1); eff.push('-1 Stamina'); }
      },
      { // Reckless finisher
        text: 'Rush between them and attempt a double decapitation',
        dc: Math.min(99, base + 24 + rnd()),
        bonus: (r)=> atkB + (r.stamina>8?3:0),
        tag: 'finisher',
        onSuccess: (r, eff)=>{ r.tokens += 10; eff.push('+10 tokens'); if(Math.random()<0.5){ giveRandomLoot(r, eff); } },
        onFail:    (r, eff)=>{ const raw = 8; const dmg = Math.max(0, raw - r.defense); r.hp -= dmg; eff.push(`-${dmg} HP (brutal counter)`); r.stamina=Math.max(0,r.stamina-2); eff.push('-2 Stamina'); }
      }
    ];

    return actions;
  }

  // Loot helpers
  function giveRandomLoot(r, eff){
    const roll = Math.random();
    if(roll < 0.50){ r.tokens += 5; eff.push('+5 tokens (purse)'); }
    else if(roll < 0.75){ r.stamina=Math.min(10, r.stamina+1); eff.push('+1 Stamina'); }
    else if(roll < 0.95){ r.nutrition=Math.min(10, r.nutrition+1); eff.push('+1 Nutrition (trail rations)'); }
    else { giveRandomGear(r, eff); }
  }

  function giveRandomGear(r, eff){
    const gRoll = Math.random();
    if(gRoll < 0.50){
      // weapon
      const w = pick(WEAPONS);
      if(!state.stash.weapons.includes(w.id)){ state.stash.weapons.push(w.id); eff.push(`FOUND weapon: ${w.name}`); persist(); }
      else { r.tokens += 4; eff.push(`Duplicate weapon → +4 tokens`); }
    } else if(gRoll < 0.98){
      // armour
      const a = pick(ARMOURS);
      if(!state.stash.armours.includes(a.id)){ state.stash.armours.push(a.id); eff.push(`FOUND armour: ${a.name}`); persist(); }
      else { r.tokens += 4; eff.push(`Duplicate armour → +4 tokens`); }
    } else {
      // ultra-rare amulet drop (~2% via this path)
      if(!state.stash.amulet.have){
        state.stash.amulet.have = true; eff.push('ULTRA RARE: Amulet of Life (1 free entry/day)');
        state.stash.trinkets.push('amulet_of_life'); persist();
      } else { r.tokens += 10; eff.push('Duplicate relic → +10 tokens'); }
    }
  }

  // ---------- Choices & Modal flow ----------
  function renderChoices(rs, choices){
    elChoices.innerHTML='';
    choices.forEach(c=>{
      const btn=document.createElement('button');
      btn.appendChild(document.createTextNode(c.text));
      btn.onclick=()=> openDiceFor(c);
      elChoices.appendChild(btn);
    });
  }

  function openDiceFor(action){
    state.pendingCheck = action;
    mTitle.textContent = 'Resolve Action';
    mSubtitle.textContent = action.text;
    mDC.textContent = 'Tap the die to roll';
    mBonus.textContent = '—';
    mResult.textContent = '—';
    mOutcome.style.display = 'none';
    mClose.style.display = 'none';
    openModal();
  }

  mDie.addEventListener('click', ()=>{
    const rs = state.run; if(!rs || !rs.alive) return;
    const act = state.pendingCheck; if(!act) return;
    if(mDie.classList.contains('rolling')) return;

    animateRoll((roll)=>{
      const bonus = (act.bonus? act.bonus(rs):0);
      const total = roll + bonus;
      const success = total >= act.dc;

      // Apply effects & collect outcome lines
      const effects = [];
      if(success){ act.onSuccess(rs, effects); }
      else { act.onFail(rs, effects); }

      // Nutrition & passive drain
      if(Math.random()<0.35 && rs.nutrition>0){ rs.nutrition--; effects.push('-1 Nutrition (effort)'); }
      if(Math.random()<0.25 && rs.stamina>0){ rs.stamina--; effects.push('-1 Stamina (exertion)'); }

      // Rare world drop chance for Amulet (~0.1% per action regardless of route)
      if(Math.random()<0.001 && !state.stash.amulet.have){
        state.stash.amulet.have = true;
        state.stash.trinkets.push('amulet_of_life');
        effects.push('ULTRA RARE WORLD DROP: Amulet of Life (free entry/day)');
        persist();
      }

      // Reveal stats in modal
      mDC.textContent   = `DC ${act.dc}`;
      mBonus.textContent= bonus ? `Bonus +${bonus}` : 'Bonus —';
      mResult.textContent = `${success?'Success':'Fail'} — roll ${roll}${bonus?` + ${bonus}`:''} = ${total}`;
      mResult.className = 'result ' + (success?'good':'bad');
      mEffects.innerHTML = effects.map(e=>`<li>${e}</li>`).join('');
      mOutcome.style.display='block';
      mClose.style.display='inline-flex';

      addLog(rs, `${act.text}: ${success?'Success':'Fail'} (${roll}${bonus?`+${bonus}`:''}=${total} vs DC ${act.dc})`, success?'good':'bad');

      state.pendingCheck = null;
      refreshUI();
    });
  });

  mClose.addEventListener('click', ()=>{ closeModal(); afterPick(); });
  mCancel.addEventListener('click', ()=>{ closeModal(); state.pendingCheck=null; });

  // ---------- Flow ----------
  function nextScenario(rs){
    const sc = scenarioFor(rs);
    rs.scenario = sc;
    const actions = makeActions(rs, sc);
    renderChoices(rs, actions);
  }

  function advanceThread(rs){
    const t = Threads[rs.thread.id];
    if(rs.thread.stage < t.stages.length-1){
      rs.thread.stage++;
    } else {
      // Completed 20-stage arc → reward and rotate to a new arc
      rs.tokens += 20;
      addLog(rs,'Arc complete (+20 tokens).','good');
      rs.thread = pickThread();
      rs.thread.stage = 0;
    }
  }

  function step(){
    const rs = state.run; if(!rs || !rs.alive) return;
    rs.depth += 1;

    // Environmental attrition
    if(Math.random()<0.25 && rs.stamina>0){ rs.stamina--; addLog(rs,'Fatigue nips at you (-1 Stamina).','bad'); }
    if(Math.random()<0.15 && rs.nutrition>0){ rs.nutrition--; addLog(rs,'Hunger gnaws (-1 Nutrition).','bad'); }

    if(isCampDepth(rs.depth)){ addLog(rs,'You reach a camp. You can retire safely here.'); }
    nextScenario(rs);
    refreshUI();
  }

  function afterPick(){
    const rs = state.run; if(!rs) return;
    // Nutrition reaching 0 can nibble HP
    if(rs.nutrition<=0 && Math.random()<0.5){ const dmg = Math.max(0, 1 - rs.defense); rs.hp -= dmg; if(dmg>0) addLog(rs,`Starvation bites (-${dmg} HP).`,'bad'); }
    if(rs.hp<=0){
      rs.alive=false; addLog(rs, `You die at depth ${rs.depth}. Unbanked tokens lost (${rs.tokens}).`, 'bad');
      state.tombstones.unshift({ runId: rs.runId, depth: rs.depth, tokens: rs.tokens, time: Date.now() });
      if(state.tombstones.length>50) state.tombstones.pop();
      state.pass=null; state.run=null; persist(); renderTombs(); refreshUI(); return;
    }
    advanceThread(rs);
    step();
  }

  // ---------- Tombstones ----------
  function renderTombs(){
    if(!state.tombstones.length){ elTombs.textContent='—'; return; }
    elTombs.innerHTML = state.tombstones.map(t=>{
      const d = new Date(t.time).toLocaleString();
      return `RIP <b>#${t.runId}</b> — depth ${t.depth}, tokens ${t.tokens} <span class="muted">(${d})</span>`;
    }).join('<br>');
  }

  // ---------- Controls ----------
  elFaucet.onclick = ()=>{ state.walletMinor += 2000; persist(); updateWallet(); };
  elWithdraw.onclick = ()=>{ state.walletMinor = Math.max(0, state.walletMinor-500); persist(); updateWallet(); };

  elStart.onclick = ()=>{
    if(state.pass || state.run) return;
    // Free entry via amulet?
    let usedAmulet = false;
    if(freeEntryAvailable()){
      usedAmulet = true;
      state.stash.amulet.lastUsed = todayStr();
      persist();
    } else {
      // Pay fee
      const fee = lastFee;
      if(state.walletMinor < fee){ alert('Insufficient funds for entry fee. Use Add Test Coins or Amulet.'); return; }
      state.walletMinor -= fee; persist(); updateWallet();
    }
    const runId = Math.floor(Date.now()/1000).toString(36);
    state.pass = { runId, entryFeeMinor: usedAmulet ? 0 : lastFee, usedAmulet };
    state.run = newRun(runId);
    addLog(state.run, `Run started. Entry ${usedAmulet?'(Amulet free)':'fee: '+fmtMinor(lastFee)}.`, 'good');
    step();
    lastFee = dynamicEntryFee(); refreshUI();
  };

  elRetire.onclick = ()=>{
    const rs = state.run; if(!rs) return;
    if(!isCampDepth(rs.depth)){ addLog(rs,'You cannot retire here. Find a camp.'); refreshUI(); return; }
    const payoutMinor = rs.tokens * 100; // 1 token = 1.00 FAKE (adjust as desired)
    state.walletMinor += payoutMinor; persist(); updateWallet();
    addLog(rs, `You retire with ${rs.tokens} tokens → ${fmtMinor(payoutMinor)}.`, 'good');
    rs.alive=false; state.pass=null; state.run=null; refreshUI();
  };

  // ---------- Init ----------
  function init(){
    renderTombs();
    refreshUI();
    renderInventory();
  }
  function renderTombs(){ if(!state.tombstones.length){ elTombs.textContent='—'; return; }
    elTombs.innerHTML = state.tombstones.map(t=>{ const d = new Date(t.time).toLocaleString();
      return `RIP <b>#${t.runId}</b> — depth ${t.depth}, tokens ${t.tokens} <span class="muted">(${d})</span>`;}).join('<br>'); }

  init();

})();
</script>
</body>
</html>
