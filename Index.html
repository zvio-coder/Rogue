<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Roguechain — Quest 1: Blackthorn Manor</title>
<style>
:root{--bg:#0b0f14;--panel:#0f1620;--panel2:#0d141d;--ink:#e6edf3;--muted:#9aa5b1;--accent:#72a1ff;--good:#42d392;--bad:#ff6b6b;--edge:#1f2a37;--shadow:0 8px 30px rgba(0,0,0,.45)}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;-webkit-tap-highlight-color:transparent}
.wrap{max-width:1024px;margin:0 auto;padding:16px}
header{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:10px}
.brand{font-weight:800;font-size:clamp(16px,2.4vw,20px)}
.wallet{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.pill{background:var(--panel);border:1px solid var(--edge);border-radius:10px;padding:8px 10px;font-size:14px}
button{background:var(--panel2);border:1px solid var(--edge);color:var(--ink);border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
button:hover{border-color:#315a9f}button:active{transform:scale(.98)}button.primary{background:#1b2736;border-color:#315a9f}
.tabs{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
.tab{padding:8px 12px;border:1px solid var(--edge);border-radius:999px;background:var(--panel2);cursor:pointer}
.tab.active{background:#1b2736;border-color:#315a9f}
main{display:grid;grid-template-columns:1.2fr .8fr;gap:12px}@media(max-width:900px){main{grid-template-columns:1fr}}
.card{background:var(--panel);border:1px solid var(--edge);border-radius:14px;padding:12px;box-shadow:var(--shadow)}
h2{margin:0 0 8px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin:8px 0}@media(max-width:520px){.stats{grid-template-columns:repeat(2,1fr)}}
.stat{background:var(--panel2);border:1px solid var(--edge);border-radius:12px;padding:8px;text-align:center;font-size:14px}
.scenario{background:var(--panel2);border:1px solid var(--edge);border-radius:12px;padding:10px;margin-top:6px}
.scenario h3{margin:0 0 6px;font-size:16px}.scenario p{margin:0;color:#cbd4df}
.tag{display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid #2a3a52;background:#1a2432;color:#9fb4d6;font-size:11px;margin-right:6px}
.choices{display:flex;flex-direction:column;gap:8px;margin-top:8px}
.log{background:var(--panel2);border:1px solid var(--edge);border-radius:12px;padding:10px;max-height:320px;overflow:auto;font:13px/1.5 ui-monospace,Consolas,Menlo,monospace}
.log .good{color:var(--good)}.log .bad{color:var(--bad)}.muted{color:var(--muted)}.divider{height:1px;background:var(--edge);margin:10px 0}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}@media(max-width:600px){.grid{grid-template-columns:1fr}}
.item{display:flex;justify-content:space-between;align-items:center;background:var(--panel2);border:1px solid var(--edge);border-radius:12px;padding:8px}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
.modal.show{display:flex}.sheet{max-width:560px;width:100%;background:var(--panel);border:1px solid var(--edge);border-radius:14px;padding:16px;box-shadow:var(--shadow)}
.modal h3{margin:0 0 6px}.modal .sub{color:var(--muted);font-size:13px;margin-bottom:8px}
.die{width:100px;height:100px;border-radius:14px;background:radial-gradient(60% 60% at 50% 45%,#1a2432 0%,#0f1620 100%);border:2px solid var(--edge);display:flex;align-items:center;justify-content:center;font:800 26px/1 ui-monospace,Consolas;color:#b8d3ff;position:relative;user-select:none}
.die .label{position:absolute;left:6px;bottom:4px;font:10px/1.2 ui-monospace;color:#9aa5b1}
.die.rolling{animation:shake .9s ease-in-out}@keyframes shake{0%{transform:rotate(0)}25%{transform:rotate(6deg)}50%{transform:rotate(-6deg)}75%{transform:rotate(3deg)}100%{transform:rotate(0)}}
.outcome{margin-top:12px;background:var(--panel2);border:1px solid var(--edge);border-radius:12px;padding:10px}.result{font-weight:800;margin-top:8px}.good{color:var(--good)}.bad{color:var(--bad)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">Roguechain — Quest 1: Blackthorn Manor (scripted)</div>
    <div class="wallet">
      <div class="pill" id="balance">Wallet: 0 Dust</div>
      <button id="btnFaucet">Add Test Dust</button>
      <button id="btnWithdraw">Withdraw 5 Dust</button>
    </div>
  </header>

  <div class="tabs">
    <div id="tabPlay" class="tab active">Play</div>
    <div id="tabInventory" class="tab">Inventory & Loadout</div>
  </div>

  <main>
    <section class="card" id="playCard">
      <h2>Blackthorn Manor — Story Mode</h2>
      <div class="row">
        <button id="btnStart" class="primary">Start Quest (Pay Entry / Use Amulet)</button>
        <div class="pill" id="entryFee">Entry fee: 5 Dust</div>
        <div class="pill" id="pass">No Pass</div>
      </div>

      <div class="stats">
        <div class="stat">HP<div id="sHP">—</div></div>
        <div class="stat">Stamina<div id="sST">—</div></div>
        <div class="stat">Nutrition<div id="sNU">—</div></div>
        <div class="stat">Defense<div id="sDF">—</div></div>
        <div class="stat">Dust<div id="sDU">—</div></div>
        <div class="stat">Stage<div id="sSTAGE">—</div></div>
      </div>

      <div class="scenario" id="scenarioBox" style="display:none">
        <div class="row" style="justify-content:space-between;align-items:center">
          <h3 id="scTitle">—</h3>
          <div id="scTags"></div>
        </div>
        <p id="scText">—</p>
      </div>

      <div class="choices" id="choices"></div>

      <div class="divider"></div>
      <div class="log" id="log"></div>
    </section>

    <section class="card" id="invCard" style="display:none">
      <h2>Inventory & Loadout</h2>
      <div class="row">
        <div class="pill" id="amuletInfo">Amulet of Life: none</div>
        <div class="pill" id="entryInfo">Free entry today: no</div>
      </div>
      <div class="divider"></div>

      <h3 style="margin-top:0">Weapons</h3>
      <div id="weaponsGrid" class="grid"></div>
      <div class="divider"></div>

      <h3>Armour</h3>
      <div id="armoursGrid" class="grid"></div>
      <div class="divider"></div>

      <h3>Trinkets</h3>
      <div id="trinketsGrid" class="grid"></div>
      <div class="divider"></div>

      <h3>Consumables</h3>
      <div id="consumablesGrid" class="grid"></div>
      <p class="muted">Bandages heal HP; Food restores Nutrition. Equipped gear persists unless you die.</p>
    </section>

    <aside class="card">
      <h2>How this works</h2>
      <ul class="muted">
        <li>Fully scripted quest: every action → fixed next scene.</li>
        <li>Animated d100, bonuses from gear/flags, effects applied automatically.</li>
        <li>Dust + loot only when it makes story sense.</li>
        <li>Escape with loot at the Epilogue; 2% chance of **Extreme Loot**.</li>
      </ul>
      <div class="divider"></div>
      <h2>Tombstones</h2>
      <div id="tombstones" class="muted">—</div>
    </aside>
  </main>

  <p class="muted" style="margin-top:10px">Saves locally (localStorage). Currency: <b>Dust</b>. Token name is <b>Dust</b>.</p>
</div>

<!-- Dice Modal -->
<div class="modal" id="diceModal" aria-modal="true" role="dialog">
  <div class="sheet">
    <h3 id="mTitle">—</h3>
    <div class="sub" id="mSubtitle">—</div>
    <div class="row" style="align-items:center;gap:14px">
      <div class="die" id="mDie" role="button" aria-label="Roll d100"><span class="value">d100</span><span class="label">d100</span></div>
      <div>
        <div id="mDC" class="muted">Tap die to roll</div>
        <div id="mBonus" class="muted">—</div>
      </div>
    </div>
    <div class="outcome" id="mOutcome" style="display:none">
      <div id="mResult" class="result">—</div>
      <ul id="mEffects" style="margin:6px 0 0 18px"></ul>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <button id="mClose" style="display:none">Continue</button>
      <button id="mCancel">Cancel</button>
    </div>
  </div>
</div>

<script>
(function(){
  // ---------- storage & helpers ----------
  const $=s=>document.querySelector(s);
  const todayStr=()=>new Date().toISOString().slice(0,10);
  const storeKey='rc-quest1-v1';
  const load=()=>{try{return JSON.parse(localStorage.getItem(storeKey)||'{}')}catch(_){return {}}};
  const save=o=>localStorage.setItem(storeKey,JSON.stringify(o));

  // ---------- gear catalog ----------
  const WEAPONS=[{id:'rust_dagger',name:'Rusty Dagger',atk:2,hp:0},
                 {id:'club',name:'Club',atk:3,hp:0},
                 {id:'knife',name:'Kitchen Knife',atk:4,hp:0},
                 {id:'short_sword',name:'Short Sword',atk:5,hp:0},
                 {id:'warblade',name:'Warblade',atk:10,hp:1},
                 {id:'mythic_warblade',name:'Mythic Warblade',atk:15,hp:2}];
  const ARMOURS=[{id:'makeshift',name:'Makeshift Shield',def:1,hp:0},
                 {id:'light',name:'Light Armor',def:2,hp:0},
                 {id:'chain',name:'Chain Shirt',def:4,hp:1},
                 {id:'tower',name:'Tower Shield',def:6,hp:0},
                 {id:'imperial_cuirass',name:'Imperial Cuirass',def:10,hp:2}];

  // ---------- persistent meta ----------
  const state={
    walletDust:0,tombstones:[],
    stash:{weapons:['rust_dagger'],armours:[],trinkets:[],consumables:{bandage:1,food:1},equip:{weapon:'rust_dagger',armour:null},amulet:{have:false,lastUsed:''}},
    pass:null, run:null
  };
  Object.assign(state,load());
  if(!state.stash) state.stash={weapons:['rust_dagger'],armours:[],trinkets:[],consumables:{bandage:1,food:1},equip:{weapon:'rust_dagger',armour:null},amulet:{have:false,lastUsed:''}};
  function persist(){ save({walletDust:state.walletDust,tombstones:state.tombstones,stash:state.stash}); }

  // ---------- dice modal ----------
  const modal=$('#diceModal'), mTitle=$('#mTitle'), mSubtitle=$('#mSubtitle'), mDie=$('#mDie'), mDC=$('#mDC'), mBonus=$('#mBonus'), mOutcome=$('#mOutcome'), mResult=$('#mResult'), mEffects=$('#mEffects'), mClose=$('#mClose'), mCancel=$('#mCancel');
  const mVal=()=>mDie.querySelector('.value');
  const openModal=()=>{modal.classList.add('show'); mOutcome.style.display='none'; mClose.style.display='none';}
  const closeModal=()=>modal.classList.remove('show');
  function animateRoll(done){ mDie.classList.add('rolling'); let t=0; const dur=900, step=60;
    (function tick(){ t+=step; mVal().textContent=(1+Math.floor(Math.random()*100)).toString().padStart(2,'0');
      if(t>=dur){ const final=1+Math.floor(Math.random()*100); mVal().textContent=final.toString().padStart(2,'0'); mDie.classList.remove('rolling'); done(final); }
      else setTimeout(tick,step);
    })();
  }

  // ---------- UI elements ----------
  const elBal=$('#balance'), elEntry=$('#entryFee'), elPass=$('#pass'), elStart=$('#btnStart'),
        sHP=$('#sHP'), sST=$('#sST'), sNU=$('#sNU'), sDF=$('#sDF'), sDU=$('#sDU'), sSTAGE=$('#sSTAGE'),
        scBox=$('#scenarioBox'), scTitle=$('#scTitle'), scText=$('#scText'), scTags=$('#scTags'), choicesEl=$('#choices'), logEl=$('#log'),
        tabPlay=$('#tabPlay'), tabInv=$('#tabInventory'), playCard=$('#playCard'), invCard=$('#invCard'),
        weaponsGrid=$('#weaponsGrid'), armoursGrid=$('#armoursGrid'), trinketsGrid=$('#trinketsGrid'), consumablesGrid=$('#consumablesGrid'),
        amuletInfo=$('#amuletInfo'), entryInfo=$('#entryInfo'), tombsEl=$('#tombstones');

  // ---------- wallet controls ----------
  const ENTRY_FEE=5;
  function updateWallet(){elBal.textContent=`Wallet: ${state.walletDust} Dust`;}
  $('#btnFaucet').onclick=()=>{state.walletDust+=20; persist(); updateWallet();};
  $('#btnWithdraw').onclick=()=>{state.walletDust=Math.max(0,state.walletDust-5); persist(); updateWallet();};

  // ---------- inventory tab ----------
  tabPlay.onclick=()=>setTab('play'); tabInv.onclick=()=>setTab('inv');
  function setTab(t){const inv=t==='inv'; playCard.style.display=inv?'none':'block'; invCard.style.display=inv?'block':'none'; tabPlay.classList.toggle('active',!inv); tabInv.classList.toggle('active',inv); if(inv) renderInventory();}
  function renderInventory(){
    amuletInfo.textContent=`Amulet of Life: ${state.stash.amulet.have?'owned':'none'}`;
    entryInfo.textContent=`Free entry today: ${(state.stash.amulet.have && state.stash.amulet.lastUsed!==todayStr())?'yes':'no'}`;
    const wEq=state.stash.equip.weapon, aEq=state.stash.equip.armour;
    weaponsGrid.innerHTML=''; (state.stash.weapons||[]).forEach(id=>{const w=WEAPONS.find(x=>x.id===id); if(!w) return; const d=document.createElement('div'); d.className='item'; d.innerHTML=`<div><b>${w.name}</b><div class="muted">+${w.atk} atk, +${w.hp} HP</div></div>`; const b=document.createElement('button'); b.textContent=(wEq===id)?'Equipped':'Equip'; b.onclick=()=>{state.stash.equip.weapon=id; persist(); renderInventory();}; d.appendChild(b); weaponsGrid.appendChild(d);});
    armoursGrid.innerHTML=''; (state.stash.armours||[]).forEach(id=>{const a=ARMOURS.find(x=>x.id===id); if(!a) return; const d=document.createElement('div'); d.className='item'; d.innerHTML=`<div><b>${a.name}</b><div class="muted">+${a.def} def, +${a.hp} HP</div></div>`; const b=document.createElement('button'); b.textContent=(aEq===id)?'Equipped':'Equip'; b.onclick=()=>{state.stash.equip.armour=id; persist(); renderInventory();}; d.appendChild(b); armoursGrid.appendChild(d);});
    trinketsGrid.innerHTML=''; (state.stash.trinkets||[]).forEach(id=>{const name=id==='amulet_of_life'?'Amulet of Life':'Trinket'; const d=document.createElement('div'); d.className='item'; d.innerHTML=`<div><b>${name}</b></div>`; const b=document.createElement('button'); b.textContent='—'; b.disabled=true; d.appendChild(b); trinketsGrid.appendChild(d);});
    consumablesGrid.innerHTML=''; const c=state.stash.consumables||{}; [['Bandage','bandage'],['Food','food']].forEach(([lbl,k])=>{const d=document.createElement('div'); d.className='item'; d.innerHTML=`<div><b>${lbl}</b><div class="muted">x${c[k]||0}</div></div>`; const b=document.createElement('button'); b.textContent='—'; b.disabled=true; d.appendChild(b); consumablesGrid.appendChild(d);});
  }

  // ---------- run setup ----------
  function gearStats(){const w=WEAPONS.find(x=>x.id===state.stash.equip.weapon)||{}; const a=ARMOURS.find(x=>x.id===state.stash.equip.armour)||{}; return {atk:w.atk||0, hp:(w.hp||0)+(a.hp||0), def:(a.def||0)};}
  function newRun(id){const g=gearStats(); return {runId:id, quest:'Quest1', stage:0, alive:true, hp:10+g.hp, stamina:8, nutrition:6, defense:g.def, dust:0, log:[], flags:{}, pending:null, node:'Q1-01'};}
  function addLog(r,msg,cls){r.log.push(`<span class="${cls||''}">${msg}</span>`);}
  function refreshUI(){
    elEntry.textContent=`Entry fee: ${ENTRY_FEE} Dust`; elPass.textContent=state.pass?`Pass #${state.pass.runId}${state.pass.usedAmulet?' (free)':''}`:'No Pass'; updateWallet();
    if(!state.run){[sHP,sST,sNU,sDF,sDU,sSTAGE].forEach(x=>x.textContent='—'); scBox.style.display='none'; choicesEl.innerHTML=''; logEl.innerHTML=''; return;}
    const r=state.run; sHP.textContent=r.hp; sST.textContent=r.stamina; sNU.textContent=r.nutrition; sDF.textContent=r.defense; sDU.textContent=r.dust; sSTAGE.textContent=r.stage+1;
    const node=Quest1.nodes[r.node]; scBox.style.display='block'; scTitle.textContent=`${node.title}`; scText.textContent=node.text; scTags.innerHTML=node.tags.map(t=>`<span class="tag">${t}</span>`).join('');
    choicesEl.innerHTML=''; node.choices.forEach((c,i)=>{const b=document.createElement('button'); b.textContent=c.text; b.onclick=()=>openCheck(node,c); choicesEl.appendChild(b);});
    logEl.innerHTML=r.log.slice(-200).map(x=>`• ${x}`).join('<br>');
  }

  // ---------- dice bonuses ----------
  function atkBonus(){const w=WEAPONS.find(x=>x.id===state.stash.equip.weapon); return w?(w.atk||0):0;}
  function defBonus(){const a=ARMOURS.find(x=>x.id===state.stash.equip.armour); return a?Math.floor((a.def||0)/2):0;}
  const bonusFns={
    atk:(r)=>atkBonus(),
    def:(r)=>defBonus(),
    stam:(r)=>Math.max(0,r.stamina-6),
    disguise:(r)=>r.flags.disguised?10:0,
    patrol:(r)=>r.flags.guard_pattern?10:0,
    route:(r)=>r.flags.safe_route_study?10:0,
    signet:(r)=>r.flags.signet?10:0,
    ally:(r)=>r.flags.freed_prisoner?10:0,
    poisoned:(r)=>r.flags.captain_poisoned?10:0,
  };

  // ---------- modal roll ----------
  function openCheck(node, choice){
    state.run.pending={nodeId:state.run.node, choiceIndex: node.choices.indexOf(choice)};
    mTitle.textContent='Resolve Action'; mSubtitle.textContent=choice.text; mDC.textContent='Tap die to roll';
    const bonus=(choice.bonus||[]).reduce((a,k)=>a+(bonusFns[k]?bonusFns[k](state.run):0),0);
    mBonus.textContent= bonus?`Bonus +${bonus}`:'Bonus —'; mOutcome.style.display='none'; mClose.style.display='none'; openModal();
    mDie.onclick=()=>{
      if(mDie.classList.contains('rolling')) return;
      animateRoll((roll)=>{
        const dc=resolveDC(choice.dc, state.run);
        const bonus=(choice.bonus||[]).reduce((a,k)=>a+(bonusFns[k]?bonusFns[k](state.run):0),0);
        const total=roll+bonus; const success=total>=dc;
        mDC.textContent=`DC ${dc}`; mResult.textContent=`${success?'Success':'Fail'} — roll ${roll}${bonus?` + ${bonus}`:''} = ${total}`; mResult.className='result ' + (success?'good':'bad');
        const effects = success ? (choice.onSuccess.effects||[]) : (choice.onFail.effects||[]);
        const list=applyEffects(effects, success?choice.onSuccess.next:choice.onFail.next, node, choice, success);
        mEffects.innerHTML=list.map(s=>`<li>${s}</li>`).join(''); mOutcome.style.display='block'; mClose.style.display='inline-flex';
      });
    };
  }
  mClose.onclick=()=>{closeModal(); goNext();};
  mCancel.onclick=()=>{closeModal(); state.run.pending=null;};

  function resolveDC(dc, r){
    if(typeof dc==='number') return dc;
    // allow functions later; for now numbers only
    return 60;
  }

  // ---------- effect application ----------
  function pushMsg(msg, cls){addLog(state.run,msg,cls);}
  function effectTextApplied(arr){return arr;}
  function applyEffects(effects, next, node, choice, success){
    const r=state.run; const msgs=[];
    // default exertion drains
    if(Math.random()<0.30 && r.nutrition>0){ r.nutrition--; msgs.push('-1 Nutrition (effort)');}
    if(Math.random()<0.20 && r.stamina>0){ r.stamina--; msgs.push('-1 Stamina (strain)');}

    for(const ef of (effects||[])){
      if(typeof ef==='string'){
        // shorthand like "+2 Dust", "-1 HP", "flag:sewer_route", "item:bandage"
        const s=ef.trim();
        if(/^[+-]\d+\s+Dust$/i.test(s)){const v=parseInt(s); r.dust+=v; msgs.push(`${v>0?'+':''}${v} Dust`);}
        else if(/^[+-]\d+\s+HP$/i.test(s)){const v=parseInt(s); r.hp+=v; msgs.push(`${v>0?'+':''}${v} HP`);}
        else if(/^[+-]\d+\s+Stamina$/i.test(s)){const v=parseInt(s); r.stamina+=v; msgs.push(`${v>0?'+':''}${v} Stamina`);}
        else if(/^[+-]\d+\s+Nutrition$/i.test(s)){const v=parseInt(s); r.nutrition+=v; msgs.push(`${v>0?'+':''}${v} Nutrition`);}
        else if(/^flag:/.test(s)){const k=s.split(':')[1]; r.flags[k]=true; msgs.push(`Flag gained: ${k.replaceAll('_',' ')}`);}
        else if(/^item:/.test(s)){const it=s.split(':')[1]; const bag=state.stash.consumables; bag[it]=(bag[it]||0)+1; msgs.push(`FOUND: ${it}`); persist();}
        else if(/^gear:weapon:/.test(s)){const id=s.split(':')[2]; if(!state.stash.weapons.includes(id)){state.stash.weapons.push(id); msgs.push(`FOUND weapon: ${WEAPONS.find(x=>x.id===id)?.name||id}`);} else {r.dust+=2; msgs.push('Duplicate weapon → +2 Dust');} persist();}
        else if(/^gear:armor:/.test(s)){const id=s.split(':')[2]; if(!state.stash.armours.includes(id)){state.stash.armours.push(id); msgs.push(`FOUND armour: ${ARMOURS.find(x=>x.id===id)?.name||id}`);} else {r.dust+=2; msgs.push('Duplicate armour → +2 Dust');} persist();}
        else if(s==='amulet_ultra'){ if(!state.stash.amulet.have){state.stash.amulet.have=true; state.stash.trinkets.push('amulet_of_life'); msgs.push('ULTRA RARE: Amulet of Life (1 free entry/day)');} else {r.dust+=10; msgs.push('+10 Dust (relic shards)');} persist();}
        else {msgs.push(s);} // raw text
      } else if(typeof ef==='function'){
        const t=ef(r,state);
        if(Array.isArray(t)) msgs.push(...t);
        else if(t) msgs.push(t);
      }
    }
    // log
    pushMsg(`${choice.text}: ${success?'Success':'Fail'}`, success?'good':'bad');
    // next node
    r.stage++;
    if(r.hp<=0){ r.node='Q1-99'; r.alive=false; msgs.push('You succumb to your wounds.'); }
    else { r.node = next || r.node; }
    return msgs;
  }

  function goNext(){
    const r=state.run; if(!r) return;
    // epilogue payout or death
    if(r.node==='Q1-90'){ // Epilogue
      const msgs=[];
      // extreme loot 2%
      if(Math.random()<0.02){
        const pick=Math.floor(Math.random()*4);
        if(pick===0){ if(!state.stash.weapons.includes('mythic_warblade')) state.stash.weapons.push('mythic_warblade'); msgs.push('EXTREME LOOT: Mythic Warblade (+15 atk, +2 HP)'); }
        else if(pick===1){ if(!state.stash.armours.includes('imperial_cuirass')) state.stash.armours.push('imperial_cuirass'); msgs.push('EXTREME LOOT: Imperial Cuirass (+10 Def, +2 HP)'); }
        else if(pick===2){ if(!state.stash.amulet.have){state.stash.amulet.have=true; state.stash.trinkets.push('amulet_of_life'); msgs.push('EXTREME LOOT: Amulet of Life (free entry/day)'); } else { r.dust+=30; msgs.push('+30 Dust (relic)'); } }
        else { r.dust+=30; msgs.push('+30 Dust'); }
      } else {
        // good loot
        const roll=Math.random();
        if(roll<0.33){ if(!state.stash.weapons.includes('short_sword')) state.stash.weapons.push('short_sword'); msgs.push('LOOT: Short Sword'); }
        else if(roll<0.66){ if(!state.stash.armours.includes('chain')) state.stash.armours.push('chain'); msgs.push('LOOT: Chain Shirt'); }
        else { r.dust+=10; msgs.push('+10 Dust (purse)'); }
      }
      persist();
      addLog(r, msgs.join(' • '), 'good');
      // end run (player must start new quest)
      state.walletDust += r.dust; persist(); updateWallet();
      addLog(r, `Quest complete: Banked ${r.dust} Dust.`, 'good');
      state.tombstones.unshift({runId:r.runId,depth:r.stage,dust:r.dust,time:Date.now(),note:'Quest complete'}); if(state.tombstones.length>50) state.tombstones.pop();
      state.run=null; state.pass=null; renderTombs(); refreshUI(); return;
    }
    if(r.node==='Q1-99'){
      state.tombstones.unshift({runId:r.runId,depth:r.stage,dust:r.dust,time:Date.now(),note:'Died'}); if(state.tombstones.length>50) state.tombstones.pop();
      addLog(r,`You die. Unbanked Dust lost (${r.dust}).`,'bad');
      state.run=null; state.pass=null; renderTombs(); refreshUI(); return;
    }
    persist(); refreshUI();
  }

  // ---------- quest graph ----------
  // Helper shorthands
  const T=(t)=>({title:t}); // not used now but reserved
  function node(id, title, text, tags, choices){return {id,title,text,tags,choices};}
  function c(text,dc,bonus,onSuccess,onFail){return {text,dc,bonus:bonus||[],onSuccess,onFail};}
  const to=(next,...effects)=>({next,effects});
  const fx=(...e)=>e;

  const Quest1={id:'Quest1', name:'Blackthorn Manor', nodes:{}};

  // ---- Act I
  Quest1.nodes['Q1-01']=node('Q1-01','Bleak Roadside','You wake bruised and gearless. Cart tracks score the mud; your ribbon hangs torn on a thorn hedge.',['ACT I','ENV'],[
    c('Follow the fresh ruts into the scrub',60,['stam'],to('Q1-02','-1 Stamina'),to('Q1-03','-1 Nutrition')),
    c('Search the hedge for anything usable',65,[],to('Q1-02','item:food'),to('Q1-02','-1 HP')),
    c('Flag down a passing farmer',55,[],to('Q1-04','flag:manor_known'),to('Q1-02')),
    c('Sit and steady yourself',40,[],to('Q1-02','+1 Stamina'),to('Q1-02'))
  ]);
  Quest1.nodes['Q1-02']=node('Q1-02','Forked Cart Tracks','Two sets of ruts diverge: one toward the old quarry, one to the south road.',['TRACK'],[
    c('Take the South Road',0,[],to('Q1-04'),to('Q1-04')),
    c('Cut toward the Old Quarry',0,[],to('Q1-05'),to('Q1-05')),
    c('Circle wide for dropped goods',62,[],to('Q1-04','item:bandage','flag:found_bandage'),to('Q1-04','-1 Stamina')),
    c('Hide and watch for a while',55,[],to('Q1-05'),to('Q1-04','-1 Nutrition'))
  ]);
  Quest1.nodes['Q1-03']=node('Q1-03','Lost the Trail','The ruts dissolve in trampled grass.',['ENV'],[
    c('Back to the fork, try again',0,[],to('Q1-02'),to('Q1-02')),
    c('Forage for berries',55,[],to('Q1-02','item:food'),to('Q1-02','-1 HP')),
    c('Call out (risky)',60,[],to('Q1-13'),to('Q1-02')),
    c('Rest and gather yourself',40,[],to('Q1-02','+1 Stamina'),to('Q1-02'))
  ]);
  Quest1.nodes['Q1-04']=node('Q1-04','South Road to Market','Ravenshade market hums. Whispers name Blackthorn Manor as a bandit nest.',['TOWN'],[
    c('Ask the innkeep about bandits',60,[],to('Q1-10','flag:sewer_route'),to('Q1-06','-1 HP')),
    c('Visit Mirek the fence',55,[],to('Q1-06','gear:weapon:rust_dagger','flag:mirek_debt'),to('Q1-06')),
    c('Stop by the healer’s tent',50,[],to('Q1-06','item:bandage','flag:help_healer'),to('Q1-06')),
    c('Sneak a look at the guard board',65,[],to('Q1-06','flag:guard_pattern'),to('Q1-06','-1 Stamina'))
  ]);
  Quest1.nodes['Q1-05']=node('Q1-05','Old Quarry Rim','An abandoned quarry yawns. Fresh cart marks vanish near a collapsed gallery.',['ENV'],[
    c('Squeeze into the gallery',65,[],to('Q1-11'),to('Q1-11','-1 HP')),
    c('Climb down to the quarry floor',60,[],to('Q1-11','item:rope'),to('Q1-11','-1 HP','-1 Stamina')),
    c('Watch from above',55,[],to('Q1-11','flag:hidden_door'),to('Q1-11')),
    c('Backtrack to town first',0,[],to('Q1-04'),to('Q1-04'))
  ]);
  Quest1.nodes['Q1-06']=node('Q1-06','Market Backstreets','Smells of stew and smoke; eyes watch from shadows.',['TOWN'],[
    c('Pickpocket a thug',70,['stam'],to('Q1-07','+3 Dust'),to('Q1-07','-2 HP')),
    c('Dig for a scrap shield',60,[],to('Q1-07','gear:armor:makeshift'),to('Q1-07','-1 HP')),
    c('Ask beggars about the manor',50,[],to('Q1-07','flag:servant_sally_port'),to('Q1-07')),
    c('Rest under the eaves',45,[],to('Q1-07','+1 Stamina'),to('Q1-07'))
  ]);
  Quest1.nodes['Q1-07']=node('Q1-07','Leaving Town','Choose your approach to the manor outskirts.',['ROUTE'],[
    c('Forest path',0,[],to('Q1-08'),to('Q1-08')),
    c('Riverbank',0,[],to('Q1-09'),to('Q1-09')),
    c('Return via the quarry',0,[],to('Q1-11'),to('Q1-11')),
    c('Head straight up the road',0,[],to('Q1-12'),to('Q1-12'))
  ]);
  Quest1.nodes['Q1-08']=node('Q1-08','Forest Path','Green hush. A twig snaps.',['ENV','STEALTH'],[
    c('Slip past the patrol',62,['patrol'],to('Q1-12'),to('Q1-13')),
    c('Forage for food',55,[],to('Q1-12','item:food'),to('Q1-12','-1 HP')),
    c('Set a snare',60,[],to('Q1-12','flag:snare_ready'),to('Q1-12','-1 Nutrition')),
    c('Call out the ambusher',70,['atk'],to('Q1-12','+2 Dust'),to('Q1-13'))
  ]);
  Quest1.nodes['Q1-09']=node('Q1-09','Riverbank','Reeds sway; the manor’s wall rises beyond.',['ENV'],[
    c('Wade quietly toward culvert',60,[],to('Q1-15'),to('Q1-12','-1 HP')),
    c('Follow driftwood for anything useful',55,[],to('Q1-12','gear:weapon:club'),to('Q1-12')),
    c('Try to catch a fish',58,[],to('Q1-12','item:food'),to('Q1-12','-1 Stamina')),
    c('Scout from the reeds',62,[],to('Q1-12','flag:kitchen_gate'),to('Q1-12','-1 HP'))
  ]);
  Quest1.nodes['Q1-10']=node('Q1-10','Sewer Route Learned','The innkeep sketches a crude map to a grate under the manor.',['INFO'],[
    c('Head for the grate at once',0,[],to('Q1-15','flag:sewer_route'),to('Q1-15'))
  ]);

  // ---- Act II (approach)
  Quest1.nodes['Q1-11']=node('Q1-11','Quarry Tunnels','Dank air, rusted gates, distant voices.',['ENV','PUZZLE'],[
    c('Use rope to cross a gap',60,[],to('Q1-20'),to('Q1-20','-1 HP')),
    c('Pry open a rusted door',65,[],to('Q1-21'),to('Q1-22')),
    c('Follow the voices',58,[],to('Q1-21','+3 Dust','item:food'),to('Q1-22')),
    c('Mark this exit for later',45,[],to('Q1-21','flag:quarry_escape'),to('Q1-21'))
  ]);
  Quest1.nodes['Q1-12']=node('Q1-12','Manor Perimeter','Torchlight paces atop the wall.',['STEALTH'],[
    c('Scale ivy on west wall',70,[],to('Q1-23'),to('Q1-24','-2 HP')),
    c('Shadow the servant cart',62,[],to('Q1-25'),to('Q1-22')),
    c('Wait for night and watch patterns',55,[],to('Q1-24','flag:guard_pattern'),to('Q1-24','-1 Nutrition')),
    c('Bluff as a messenger at the gate',72,[],to('Q1-26'),to('Q1-22'))
  ]);
  Quest1.nodes['Q1-13']=node('Q1-13','Forest Ambush','A cutthroat lunges from the brush.',['COMBAT'],[
    c('Dodge and break away',65,['stam'],to('Q1-12','+2 Dust'),to('Q1-12','-2 HP')),
    c('Counterattack bare-handed',75,['atk'],to('Q1-12','+4 Dust','gear:weapon:rust_dagger'),to('Q1-12','-3 HP')),
    c('Throw dirt & flee',60,[],to('Q1-12'),to('Q1-12','-1 Stamina')),
    c('Offer a future cut to stand down',68,[],to('Q1-12','flag:bandit_contact'),to('Q1-12','-1 HP'))
  ]);
  Quest1.nodes['Q1-15']=node('Q1-15','Sewer Grate','Cold iron bars; the stone is slick.',['LOCK','TRAP'],[
    c('Pick the grate',68,[],to('Q1-27'),to('Q1-27','-2 HP')),
    c('Pry the bars',70,['stam'],to('Q1-27'),to('Q1-27','-1 Stamina')),
    c('Search for alternate culvert',62,[],to('Q1-27','flag:quiet_entry'),to('Q1-27','-1 Nutrition')),
    c('Wait for midnight flow to drop',50,[],to('Q1-27'),to('Q1-27','-1 HP'))
  ]);

  // ---- Act III (inside)
  Quest1.nodes['Q1-20']=node('Q1-20','Sub-cellar','Dusty racks and old casks.',['SEARCH'],[
    c('Search the racks',60,[],to('Q1-28','+3 Dust','item:food'),to('Q1-28','-1 Stamina')),
    c('Listen at the trapdoor',55,[],to('Q1-21','flag:kitchen_sched'),to('Q1-21')),
    c('Take a cask as a shield',50,[],to('Q1-21','flag:cask_shield','+1 Defense'),to('Q1-22')),
    c('Mark the route out',0,[],to('Q1-21','flag:subcellar_escape'),to('Q1-21'))
  ]);
  Quest1.nodes['Q1-21']=node('Q1-21','Cold Room','Hanging meats, breath fogs.',['STEALTH'],[
    c('Don a servant cloak',55,[],to('Q1-29','flag:disguised'),to('Q1-29','-1 Nutrition')),
    c('Sneak through the pantry',60,[],to('Q1-25'),to('Q1-22')),
    c('Lock the cellar door behind you',58,[],to('Q1-25','flag:delay_patrol'),to('Q1-25','-1 HP')),
    c('Hide and observe the rhythm',55,[],to('Q1-25','flag:break_window'),to('Q1-25','-1 Nutrition'))
  ]);
  Quest1.nodes['Q1-22']=node('Q1-22','Detained by Guards','Firm hands seize your arms.',['SOCIAL/COMBAT'],[
    c('Lie that you are a courier',72,['disguise'],to('Q1-26'),to('Q1-30')),
    c('Offer a bribe (3 Dust)',55,[],to('Q1-31','-3 Dust'),to('Q1-30','-3 Dust')),
    c('Sudden shove & run',68,['stam'],to('Q1-29'),to('Q1-30','-3 HP')),
    c('Fight your way free',75,['atk'],to('Q1-29','+5 Dust'),to('Q1-30','-4 HP'))
  ]);
  Quest1.nodes['Q1-23']=node('Q1-23','Roof Eaves','Tiles crunch softly beneath you.',['STEALTH'],[
    c('Pry a window',65,[],to('Q1-32'),to('Q1-31')),
    c('Traverse to the skylight',70,[],to('Q1-33'),to('Q1-31','-2 HP')),
    c('Descend on a rope to the balcony',68,[],to('Q1-34'),to('Q1-31','-1 Stamina')),
    c('Observe rooftop patrol',55,[],to('Q1-23','flag:roof_timing'),to('Q1-31','-1 HP'))
  ]);
  Quest1.nodes['Q1-24']=node('Q1-24','Hedge Shadow','You wait, studying patterns.',['STEALTH'],[
    c('Try the wall again',0,[],to('Q1-12'),to('Q1-12')),
    c('Circle to the servant yard',0,[],to('Q1-25'),to('Q1-25')),
    c('Bide time and conserve energy',45,[],to('Q1-12','+1 Stamina'),to('Q1-12')),
    c('Withdraw and rethink',0,[],to('Q1-12'),to('Q1-12'))
  ]);
  Quest1.nodes['Q1-25']=node('Q1-25','Kitchens','Heat, knives, and shouting cooks.',['SOCIAL','STEALTH'],[
    c('Blend in with servants',60,['disguise'],to('Q1-29'),to('Q1-22')),
    c('Spike a wine decanter',70,[],to('Q1-29','flag:poisoned_wine'),to('Q1-29','-1 Stamina')),
    c('Steal a knife',55,[],to('Q1-29','gear:weapon:knife'),to('Q1-29','-1 HP')),
    c('Grab a loaf of bread',50,[],to('Q1-29','item:food'),to('Q1-29'))
  ]);
  Quest1.nodes['Q1-26']=node('Q1-26','Front Hall','Polished marble and a looming statue.',['SOCIAL'],[
    c('Demand to see the steward',70,['signet'],to('Q1-35'),to('Q1-30')),
    c('Sneak behind the statue',62,[],to('Q1-36'),to('Q1-22')),
    c('Pretend to be a minstrel',72,[],to('Q1-31'),to('Q1-22')),
    c('Lift a signet from the cloakroom',68,[],to('Q1-35','flag:signet'),to('Q1-22','-1 HP'))
  ]);
  Quest1.nodes['Q1-27']=node('Q1-27','Sewers','Gases blur your eyes; water whispers.',['ENV','TRAP'],[
    c('Avoid gas pockets',60,[],to('Q1-36'),to('Q1-36','-2 HP')),
    c('Swim the sump',65,['stam'],to('Q1-30'),to('Q1-30','-1 Stamina')),
    c('Search flotsam',55,[],to('Q1-36','+2 Dust','flag:lockpick'),to('Q1-36','-1 HP')),
    c('Wait and listen',50,[],to('Q1-36','flag:guard_pattern'),to('Q1-36'))
  ]);
  Quest1.nodes['Q1-28']=node('Q1-28','Barrel Store','Cool and quiet.',['SEARCH'],[
    c('Onward to the stairs',0,[],to('Q1-29'),to('Q1-29')),
    c('Take a moment to breathe',45,[],to('Q1-29','+1 Stamina'),to('Q1-29')),
    c('Eat from your find',0,[],to('Q1-29','item:food'),to('Q1-29')),
    c('Listen for patrols',55,[],to('Q1-29','flag:guard_pattern'),to('Q1-29'))
  ]);
  Quest1.nodes['Q1-29']=node('Q1-29','Servants’ Stairs','A narrow stairwell spirals up and down.',['HUB'],[
    c('Up to the Gallery',0,[],to('Q1-31'),to('Q1-31')),
    c('Down to the Cells',0,[],to('Q1-30'),to('Q1-30')),
    c('Across to the Library',0,[],to('Q1-34'),to('Q1-34')),
    c('Slip into the secret panel',0,[],to('Q1-36'),to('Q1-36'))
  ]);
  Quest1.nodes['Q1-30']=node('Q1-30','Cell Block','Groans echo behind the bars.',['RESCUE'],[
    c('Free a prisoner',62,[],to('Q1-29','flag:freed_prisoner'),to('Q1-29')),
    c('Interrogate the gaoler',65,[],to('Q1-37','flag:armory_key'),to('Q1-29','-2 HP')),
    c('Search confiscated goods',60,[],to('Q1-29','+2 Dust','gear:weapon:short_sword'),to('Q1-29','-1 Stamina')),
    c('Stash contraband for exit',50,[],to('Q1-29','flag:cell_stash'),to('Q1-29'))
  ]);
  Quest1.nodes['Q1-31']=node('Q1-31','Gallery','Soft music; eyes and blades both glitter.',['STEALTH','SOCIAL'],[
    c('Blend with guests',62,['signet'],to('Q1-35'),to('Q1-22')),
    c('Cut a noble’s purse',68,[],to('Q1-35','+5 Dust'),to('Q1-22','-2 HP')),
    c('Slip behind a tapestry',60,[],to('Q1-36'),to('Q1-36','-1 Stamina')),
    c('Start a distraction',65,[],to('Q1-34'),to('Q1-22'))
  ]);
  Quest1.nodes['Q1-32']=node('Q1-32','Attic','Dust motes swim in candlelight.',['SEARCH'],[
    c('Find old guard armor',62,[],to('Q1-33','gear:armor:light'),to('Q1-33','-1 Stamina')),
    c('Discover peep vents',55,[],to('Q1-33','flag:target_in_study'),to('Q1-33')),
    c('Rope to a chandelier path',65,[],to('Q1-33'),to('Q1-33','-1 HP')),
    c('Cache a backup weapon',45,[],to('Q1-33','flag:attic_cache'),to('Q1-33'))
  ]);
  Quest1.nodes['Q1-33']=node('Q1-33','Skylight Above the Hall','The steward’s voice carries.',['STEALTH'],[
    c('Eavesdrop on the steward',60,[],to('Q1-38','flag:safe_route_study'),to('Q1-26')),
    c('Cut the glass and descend',70,[],to('Q1-26'),to('Q1-26','-2 HP')),
    c('Traverse to library roof',62,[],to('Q1-34'),to('Q1-34','-1 Stamina')),
    c('Cross back to eaves',0,[],to('Q1-23'),to('Q1-23'))
  ]);
  Quest1.nodes['Q1-34']=node('Q1-34','Library','Stacks of tomes; the smell of vellum.',['PUZZLE','SEARCH'],[
    c('Solve the shelf sigil',68,[],to('Q1-38'),to('Q1-38','-1 Stamina')),
    c('Search the desk',62,[],to('Q1-38','flag:map_of_manor'),to('Q1-38','-1 HP')),
    c('Hide among the stacks',55,[],to('Q1-38'),to('Q1-22')),
    c('Take a heavy tome',50,[],to('Q1-38','flag:book_bludgeon'),to('Q1-38'))
  ]);
  Quest1.nodes['Q1-35']=node('Q1-35','Audience Chamber','Banners stir; the steward presides.',['SOCIAL'],[
    c('Accuse the captain openly',72,['signet'],to('Q1-41'),to('Q1-22')),
    c('Butter up the steward',65,[],to('Q1-38','flag:steward_allied'),to('Q1-38')),
    c('Spike the captain’s wine (if flagged)',55,[],to('Q1-38','flag:captain_poisoned'),to('Q1-38')),
    c('Plant fake orders',60,[],to('Q1-38','flag:thin_guards'),to('Q1-38'))
  ]);
  Quest1.nodes['Q1-36']=node('Q1-36','Secret Panel','Narrow beams and dust.',['INFIL'],[
    c('Crawl the service shaft',60,[],to('Q1-38'),to('Q1-38','-1 HP')),
    c('Loose a grate to the cells',55,[],to('Q1-30'),to('Q1-30','-1 Stamina')),
    c('Plant an escape rope',50,[],to('Q1-38','flag:panel_escape'),to('Q1-38')),
    c('Wait and watch the corridor',52,[],to('Q1-38','flag:guard_pattern'),to('Q1-38'))
  ]);
  Quest1.nodes['Q1-37']=node('Q1-37','Armory','Racks of steel await.',['LOOT'],[
    c('Take a Short Sword',0,[],to('Q1-38','gear:weapon:short_sword'),to('Q1-38')),
    c('Take a Chain Shirt',0,[],to('Q1-38','gear:armor:chain'),to('Q1-38')),
    c('Take a Tower Shield',0,[],to('Q1-38','gear:armor:tower'),to('Q1-38')),
    c('Take the Warblade',0,[],to('Q1-38','gear:weapon:warblade','+1 HP'),to('Q1-38'))
  ]);
  Quest1.nodes['Q1-38']=node('Q1-38','Study Corridor','Footsteps and murmurs beyond the doors.',['STEALTH','HUB'],[
    c('Sneak into the Study',65,['route'],to('Q1-39'),to('Q1-40')),
    c('Take the Bedroom route',62,[],to('Q1-42'),to('Q1-40')),
    c('Leave a calling card to lure him',55,[],to('Q1-43'),to('Q1-40')),
    c('Rig a trap on the corridor',68,[],to('Q1-39','flag:trap_ready'),to('Q1-39','-1 HP'))
  ]);

  // ---- Act IV (boss setups)
  Quest1.nodes['Q1-39']=node('Q1-39','The Study','Maps, a locked chest, and the bandit captain.',['BOSS PREP'],[
    c('Ambush from behind',70,['ally'],to('Q1-41'),to('Q1-40')),
    c('Poison his cup',60,[],to('Q1-41','flag:captain_poisoned'),to('Q1-40')),
    c('Crack the chest quietly',72,[],to('Q1-41','+8 Dust','flag:captain_exit'),to('Q1-40')),
    c('Intimidate with evidence',68,['signet'],to('Q1-41'),to('Q1-40'))
  ]);
  Quest1.nodes['Q1-40']=node('Q1-40','Hall Clash','Steel rings as minions pour in.',['COMBAT'],[
    c('Fall back to your planted trap',65,[],to('Q1-41','flag:guards_thinned'),to('Q1-41','-3 HP')),
    c('Flee to library & reset',62,[],to('Q1-39'),to('Q1-41','-2 HP')),
    c('Rally the freed prisoner',55,['ally'],to('Q1-41','flag:ally_bonus'),to('Q1-41','-1 HP')),
    c('Hurl a cask/torch',60,[],to('Q1-41','+3 Dust'),to('Q1-41','-1 Stamina'))
  ]);
  Quest1.nodes['Q1-41']=node('Q1-41','Boss Duel','The Bandit Captain grins and draws steel.',['BOSS'],[
    c('Measured strikes',70,['atk','poisoned'],to('Q1-44'),to('Q1-45','-3 HP')),
    c('Go for the disarm',72,['def'],to('Q1-41','flag:boss_weakened'),to('Q1-45','-2 HP')),
    c('Call out his crimes to shake him',65,[],to('Q1-41','flag:boss_shaken'),to('Q1-41')),
    c('Desperate lunge',78,['stam'],to('Q1-44'),to('Q1-45','-4 HP'))
  ]);
  Quest1.nodes['Q1-42']=node('Q1-42','Bedroom','Perfume, steel, secrets.',['STEALTH','LOOT'],[
    c('Search for ledger evidence',62,[],to('Q1-39','flag:evidence'),to('Q1-40')),
    c('Take armor from armoire',60,[],to('Q1-39','gear:armor:light'),to('Q1-39','-1 Stamina')),
    c('Hide and wait behind the drapes',55,[],to('Q1-41'),to('Q1-40')),
    c('Set a room snare',65,[],to('Q1-39','flag:trap_ready'),to('Q1-39','-1 HP'))
  ]);
  Quest1.nodes['Q1-43']=node('Q1-43','Roof Chase','The captain bolts for the rooftops.',['CHASE'],[
    c('Leap the gap to tackle him',68,[],to('Q1-41','flag:boss_shaken'),to('Q1-41','-2 HP')),
    c('Slide down ivy to cut him off',65,[],to('Q1-41'),to('Q1-41','-1 Stamina')),
    c('Hurl a thrown object',60,[],to('Q1-41','flag:boss_weakened'),to('Q1-41')),
    c('Let him run; tail him',62,[],to('Q1-41','flag:stash_found'),to('Q1-41'))
  ]);
  Quest1.nodes['Q1-45']=node('Q1-45','Boss Phase 2','Wounded, the captain fights dirty.',['BOSS'],[
    c('Grapple and pin',70,['def'],to('Q1-44'),to('Q1-46','-3 HP')),
    c('Strike at the weak spot',72,['atk'],to('Q1-44'),to('Q1-46','-3 HP')),
    c('Kick the table to gain space',62,[],to('Q1-41'),to('Q1-41','-1 Stamina')),
    c('Feign collapse, counter hard',75,[],to('Q1-44'),to('Q1-46','-4 HP'))
  ]);
  Quest1.nodes['Q1-46']=node('Q1-46','Near Death','Blood slicks your hands.',['CHECK'],[
    c('Bandage up',55,[],(r)=>({next:'Q1-41',effects:(state.stash.consumables.bandage>0?['+2 HP',function(){state.stash.consumables.bandage--; return 'Used Bandage';}]:['(No bandage)'])}),(r)=>({next:'Q1-41',effects:['Wasted effort']})),
    c('Crawl for a weapon',60,[],to('Q1-41','flag:attic_cache','gear:weapon:short_sword'),to('Q1-41','-1 HP')),
    c('Plead and stall',58,[],to('Q1-41','flag:boss_shaken'),to('Q1-41')),
    c('Final stand',78,[],to('Q1-44'),to('Q1-99'))
  ]);

  // ---- Act V (resolution)
  Quest1.nodes['Q1-44']=node('Q1-44','Captain Falls','He crashes to the floor, breath ragged.',['RESOLUTION'],[
    c('Finish him',0,[],to('Q1-47','flag:captain_dead'),to('Q1-47')),
    c('Spare him for information',55,[],to('Q1-47','flag:vault_niche','+2 Dust'),to('Q1-47','-1 HP')),
    c('Deliver him to the steward',60,[],to('Q1-47','flag:steward_bonus'),to('Q1-47')),
    c('Search the study thoroughly',62,[],to('Q1-47','+5 Dust','flag:evidence'),to('Q1-47','-1 Nutrition'))
  ]);
  Quest1.nodes['Q1-47']=node('Q1-47','Escape Route','It’s time to leave Blackthorn Manor.',['ESCAPE'],[
    c('Secret panel rope',55,[],to('Q1-90'),to('Q1-90','-1 HP')),
    c('Sub-cellar to quarry',55,[],to('Q1-90'),to('Q1-90','-1 Stamina')),
    c('Walk out with a writ',55,[],to('Q1-90'),to('Q1-90','-1 HP')),
    c('Roof and night garden',60,[],to('Q1-90'),to('Q1-90','-1 HP'))
  ]);
  Quest1.nodes['Q1-90']=node('Q1-90','Epilogue: Settlement','You sell what you can and settle scores.',['REWARDS'],[
    c('Take reward & tally loot',0,[],to('Q1-90',function(r){r.dust+=(10 + (r.flags.steward_bonus?5:0) + (r.flags.evidence?5:0) + (r.flags.captain_poisoned?2:0) + (r.flags.found_bandage?1:0) + (r.flags.cell_stash?1:0) + (r.flags.stash_found?3:0)); return `Quest payout tallied (+${r.dust} Dust total in run)`;}),to('Q1-90'))
  ]);
  Quest1.nodes['Q1-99']=node('Q1-99','Death','Your story ends here…',['TOMBSTONE'],[
    c('Accept your fate',0,[],to('Q1-99'),to('Q1-99')),
    c('—',0,[],to('Q1-99'),to('Q1-99')),
    c('—',0,[],to('Q1-99'),to('Q1-99')),
    c('—',0,[],to('Q1-99'),to('Q1-99'))
  ]);

  // ---------- start / controls ----------
  function renderTombs(){ if(!state.tombstones.length){tombsEl.textContent='—'; return;} tombsEl.innerHTML=state.tombstones.map(t=>`RIP <b>#${t.runId}</b> — stage ${t.depth}, Dust ${t.dust} <span class="muted">(${new Date(t.time).toLocaleString()})</span> ${t.note?'— '+t.note:''}`).join('<br>'); }
  $('#btnStart').onclick=()=>{
    if(state.pass||state.run) return;
    let used=false;
    if(state.stash.amulet.have && state.stash.amulet.lastUsed!==todayStr()){ used=true; state.stash.amulet.lastUsed=todayStr(); persist(); }
    else{ if(state.walletDust<ENTRY_FEE){ alert('Not enough Dust. Use Add Test Dust or Amulet.'); return; } state.walletDust-=ENTRY_FEE; persist(); updateWallet(); }
    const id=Math.floor(Date.now()/1000).toString(36);
    state.pass={runId:id,usedAmulet:used}; state.run=newRun(id);
    addLog(state.run,`Quest started. Entry ${used?'(Amulet free)':ENTRY_FEE+' Dust'}.`,'good');
    refreshUI();
  };

  // ---------- initial UI ----------
  function init(){ elEntry.textContent=`Entry fee: ${ENTRY_FEE} Dust`; updateWallet(); renderInventory(); renderTombs(); refreshUI(); }
  init();

})();
</script>
</body>
</html>
